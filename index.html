<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel System Pro | Version 4.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #ef4444; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--t); }

        #loadingScreen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        header { background: var(--c); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--p); }
        .logo-wrap img { height: 45px; border-radius: 8px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 15px; }
        .card { background: var(--c); padding: 20px; border-radius: 18px; border: 1px solid #334155; margin-bottom: 20px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¨Ø­Ø« */
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; background: #1e293b; padding: 20px; border-radius: 15px; border: 1px solid var(--p); }
        input, button, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 14px; }
        
        .table-wrap { overflow-x: auto; background: #1e293b; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: #0f172a; padding: 15px; color: var(--p); text-align: center; border-bottom: 2px solid var(--p); }
        td { padding: 12px; border-bottom: 1px solid #334155; text-align: center; }
        
        .thumb { width: 50px; height: 50px; border-radius: 8px; cursor: pointer; object-fit: cover; border: 1px solid #444; }
        .plate-box { background: #fff; color: #000; padding: 3px 10px; border-radius: 5px; font-weight: 900; border: 2px solid #000; font-size: 13px; }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
        #statusOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .loader-box { text-align: center; padding: 30px; background: #1e293b; border-radius: 20px; border: 1px solid var(--p); }

        .btn-main { background: var(--p); border: none; font-weight: 900; cursor: pointer; transition: 0.3s; color: white; }
        .btn-success { background: var(--s); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div style="font-size: 40px; margin-bottom: 20px;">âš¡</div>
    <b>Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø¸Ø§Ù…...</b>
</div>

<div id="statusOverlay">
    <div class="loader-box">
        <div id="statusIcon" style="font-size: 50px; margin-bottom: 15px;">â³</div>
        <h3 id="statusMsg">Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
        <p style="font-size: 12px; color: #94a3b8;">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø­ØªÙ‰ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
        <button id="okBtn" class="btn-main hidden" onclick="location.reload()" style="margin-top:15px; width:150px;">ØªÙ…</button>
    </div>
</div>

<header>
    <div class="logo-wrap">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <span style="font-weight:900; color:var(--p); margin-right:10px;">Ù†Ø¸Ø§Ù… Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ</span>
    </div>
    <button onclick="logout()" style="width:auto; background:var(--d); border:none; padding:8px 20px; border-radius:10px; color:white; font-weight:bold; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">
    <section id="sec_auth" class="hidden">
        <div class="card" style="max-width:400px; margin: 50px auto; text-align:center;">
            <div id="login_box">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <input type="text" id="uInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
                <input type="password" id="pInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-main" style="height:55px; margin-top:15px;" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                <button onclick="toggleAuth(true)" style="background:transparent; color:var(--p); border:none; margin-top:15px;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div id="reg_box" class="hidden">
                <h2>Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</h2>
                <input type="text" id="r_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨">
                <input type="text" id="r_plate" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ù…Ø«Ø§Ù„: Ø£ Ø¨ Ø¬ 1234)">
                <input type="text" id="r_proj" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                <input type="text" id="r_reg" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
                <input type="text" id="r_user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¯Ø®ÙˆÙ„">
                <input type="password" id="r_pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-main btn-success" onclick="handleRegister()" style="height:55px; margin-top:15px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
                <button onclick="toggleAuth(false)" style="background:transparent; color:var(--p); border:none;">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </section>

    <section id="sec_admin" class="hidden">
        <div class="filter-grid">
            <input type="text" id="sPlate" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©..." oninput="filterData()">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Ù…Ù†:</label>
                <input type="date" id="dFrom" onchange="filterData()">
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Ø¥Ù„Ù‰:</label>
                <input type="date" id="dTo" onchange="filterData()">
            </div>
            <button onclick="exportToExcel()" style="background:#4f46e5; font-weight:bold;">ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel ğŸ“¥</button>
        </div>

        <div class="card">
            <div class="table-wrap">
                <table id="adminTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                            <th>Ø§Ù„Ù„ÙˆØ­Ø©</th>
                            <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù„ÙˆØ­Ø© / Ù‚Ø¨Ù„ / Ø¨Ø¹Ø¯</th>
                            <th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="sec_driver" class="hidden">
        <div class="card" style="text-align:center;">
            <h3 id="driverName" style="color:var(--p); margin-bottom:5px;">...</h3>
            <p id="driverInfo" style="font-size:13px; margin-top:0; color:#94a3b8;"></p>
            
            <video id="v" autoplay playsinline style="width:100%; max-width:500px; border-radius:15px; border:3px solid var(--p); background:#000; margin-bottom:15px;"></video>
            
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <button class="btn-main" onclick="takePic('p')">ğŸ“¸ ØªØµÙˆÙŠØ± Ø§Ù„Ù„ÙˆØ­Ø©</button>
                <button class="btn-main" onclick="takePic('b')">ğŸ“¸ Ø¹Ø¯Ø§Ø¯ (Ù‚Ø¨Ù„)</button>
                <button class="btn-main" onclick="takePic('a')">ğŸ“¸ Ø¹Ø¯Ø§Ø¯ (Ø¨Ø¹Ø¯)</button>
                <button class="btn-main" id="vBtn" onclick="toggleVid()" style="background:var(--d);">ğŸ¥ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ</button>
            </div>

            <div style="display:flex; justify-content:center; gap:10px; margin: 15px 0;">
                <div id="prv_p" class="hidden">ğŸ–¼ï¸ Ø§Ù„Ù„ÙˆØ­Ø©</div>
                <div id="prv_b" class="hidden">ğŸ–¼ï¸ Ù‚Ø¨Ù„</div>
                <div id="prv_a" class="hidden">ğŸ–¼ï¸ Ø¨Ø¹Ø¯</div>
                <div id="prv_v" class="hidden">ğŸ¬ ÙÙŠØ¯ÙŠÙˆ</div>
            </div>

            <button class="btn-main btn-success" id="sBtn" style="height:65px; font-size:18px;" onclick="uploadReport()" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø¯ÙŠØ±</button>
        </div>
    </section>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©
const fb = { apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas", authDomain: "tama-6219c.firebaseapp.com", databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com", projectId: "tama-6219c", appId: "1:285162278384:web:8264d5439564660b616135" };
firebase.initializeApp(fb);
const auth = firebase.auth(); const db = firebase.database();

let currentUserData = null;
let reportsList = [];
let mediaData = { p:null, b:null, a:null, v:null };

// Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
auth.onAuthStateChanged(user => {
    document.getElementById('loadingScreen').style.display = 'none';
    if (!user) { show('sec_auth'); }
    else {
        db.ref('users/' + user.uid).once('value', s => {
            const d = s.val();
            if (d && d.role === 'admin') { show('sec_admin'); loadAdminData(); }
            else if (d) {
                currentUserData = d;
                show('sec_driver');
                document.getElementById('driverName').innerText = d.name;
                document.getElementById('driverInfo').innerText = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${d.project} | Ø§Ù„Ù„ÙˆØ­Ø©: ${d.plate}`;
                startCam();
            }
        });
    }
});

function show(id) { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function toggleAuth(reg) { document.getElementById('login_box').classList.toggle('hidden', reg); document.getElementById('reg_box').classList.toggle('hidden', !reg); }

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
async function handleLogin() {
    const u = document.getElementById('uInp').value, p = document.getElementById('pInp').value;
    try { await auth.signInWithEmailAndPassword(u.includes('@') ? u : `${u}@fuel.com`, p); } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"); }
}

async function handleRegister() {
    const d = { n: document.getElementById('r_name').value, pl: document.getElementById('r_plate').value, pj: document.getElementById('r_proj').value, rg: document.getElementById('r_reg').value, u: document.getElementById('r_user').value, p: document.getElementById('r_pass').value };
    if(!d.n || !d.u || !d.p) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    try {
        const res = await auth.createUserWithEmailAndPassword(`${d.u}@fuel.com`, d.p);
        await db.ref('users/' + res.user.uid).set({name:d.n, plate:d.pl, project:d.pj, region:d.rg, role:'driver'});
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­"); location.reload();
    } catch(e) { alert(e.message); }
}

function logout() { auth.signOut().then(() => location.reload()); }

// Ø§Ù„Ø³Ø§Ø¦Ù‚: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
let stream, recorder, chunks = [];

async function startCam() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
        document.getElementById('v').srcObject = stream;
    } catch(e) { alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©"); }
}

function takePic(type) {
    const video = document.getElementById('v');
    const canvas = document.createElement('canvas');
    canvas.width = 640; canvas.height = 480; // Ø­Ø¬Ù… Ù…ØªÙˆØ³Ø· Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© ÙˆØ³Ø±Ø¹Ø© Ø±ÙØ¹
    canvas.getContext('2d').drawImage(video, 0, 0, 640, 480);
    mediaData[type] = canvas.toDataURL('image/jpeg', 0.6); // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø³Ø¨Ø© 60%
    document.getElementById('prv_'+type).classList.remove('hidden');
    checkStatus();
}

function toggleVid() {
    if (recorder && recorder.state === "recording") {
        recorder.stop();
        document.getElementById('vBtn').innerText = "ğŸ¥ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ";
    } else {
        chunks = [];
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, {type:'video/mp4'});
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                mediaData.v = reader.result;
                document.getElementById('prv_v').classList.remove('hidden');
                checkStatus();
            };
        };
        recorder.start();
        document.getElementById('vBtn').innerText = "ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (8Ø«)...";
        setTimeout(() => { if(recorder.state === "recording") recorder.stop(); }, 8000);
    }
}

function checkStatus() {
    if(mediaData.p && mediaData.b && mediaData.a && mediaData.v) document.getElementById('sBtn').disabled = false;
}

// Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
function uploadReport() {
    document.getElementById('statusOverlay').style.display = 'flex';
    navigator.geolocation.getCurrentPosition(async pos => {
        const report = {
            name: currentUserData.name, plate: currentUserData.plate, project: currentUserData.project, 
            region: currentUserData.region, imgP: mediaData.p, imgB: mediaData.b, imgA: mediaData.a, 
            video: mediaData.v, lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now()
        };
        
        try {
            await db.ref('reports').push(report);
            document.getElementById('statusIcon').innerText = "âœ…";
            document.getElementById('statusMsg').innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!";
            document.getElementById('okBtn').classList.remove('hidden');
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            document.getElementById('statusOverlay').style.display = 'none';
        }
    }, () => {
        alert("ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ GPS Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
        document.getElementById('statusOverlay').style.display = 'none';
    });
}

// Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
function loadAdminData() {
    db.ref('reports').on('value', s => {
        reportsList = [];
        s.forEach(child => { reportsList.push({id: child.key, ...child.val()}); });
        filterData();
    });
}

function filterData() {
    const q = document.getElementById('sPlate').value.toLowerCase();
    const from = document.getElementById('dFrom').value;
    const to = document.getElementById('dTo').value;

    let filtered = reportsList.filter(r => {
        const matchPlate = r.plate.toLowerCase().includes(q);
        const rDate = new Date(r.ts).toISOString().split('T')[0];
        const matchDate = (!from || rDate >= from) && (!to || rDate <= to);
        return matchPlate && matchDate;
    });

    renderTable(filtered);
}

function renderTable(data) {
    let html = '';
    data.reverse().forEach(r => {
        const dt = new Date(r.ts).toLocaleString('ar-SA');
        html += `<tr>
            <td><b>${r.name}</b></td>
            <td><span class="plate-box">${r.plate}</span></td>
            <td>${r.project} / ${r.region}</td>
            <td>${dt}</td>
            <td>
                <img src="${r.imgP}" class="thumb" onclick="vFull(this.src)" title="Ø§Ù„Ù„ÙˆØ­Ø©">
                <img src="${r.imgB}" class="thumb" onclick="vFull(this.src)" title="Ù‚Ø¨Ù„">
                <img src="${r.imgA}" class="thumb" onclick="vFull(this.src)" title="Ø¨Ø¹Ø¯">
            </td>
            <td><a href="${r.video}" download="fuel_video.mp4" style="color:var(--s); font-size:12px;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a></td>
            <td><a href="https://www.google.com/maps?q=${r.lat},${r.lng}" target="_blank" style="color:var(--p);">ğŸ“ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = html || '<tr><td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
}

function vFull(s) { const w = window.open(""); w.document.write(`<img src="${s}" style="width:100%">`); }
function exportToExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('adminTable')), "Fuel_Audit_Report.xlsx"); }
</script>
</body>
</html>
