<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fuel Proof â€“ Zahrani Logistics</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    * {box-sizing:border-box;font-family:'Cairo',system-ui;}
    body {margin:0;background:#0b1220;color:#e5e7eb;display:flex;flex-direction:column;min-height:100vh;}
    header {background:#020617;padding:18px 24px;display:flex;align-items:center;gap:16px;justify-content:flex-start;}
    header img {height:64px;max-width:220px;object-fit:contain;}
    header h1 {font-size:18px;margin:0;}

    main {padding:20px;max-width:1200px;margin:auto;flex:1;}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;}
    .card {background:#020617;border-radius:18px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,.35);transition:transform .2s;}
    .card:hover {transform:translateY(-5px);}
    .card h3 {text-align:center;margin-top:0;font-size:18px;}

    input, button {border-radius:14px;padding:12px;border:none;font-size:14px;}
    input {width:100%;background:#020617;color:#e5e7eb;border:1px solid #334155;}
    input:focus {outline:none;border-color:#22c55e;}
    button {background:#22c55e;font-weight:800;cursor:pointer;color:#fff;transition:background .2s;}
    button:hover {background:#16a34a;}
    button.secondary {background:#334155;color:#e5e7eb;}

    video, canvas, img {width:100%;border-radius:14px;}
    .row {display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
    .hidden {display:none;}

    footer {text-align:center;opacity:.6;font-size:12px;margin:30px 0;}

    /* Center LOGIN & REGISTER */
    #authBox {display:flex;align-items:center;justify-content:center;min-height:70vh;gap:20px;flex-wrap:wrap;}
    #authBox .card {max-width:400px;width:100%;}
  </style>
</head>
<body>

<header>
  <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Fuel Proof">
  <h1>Fuel Proof System</h1>
</header>

<!-- LOGIN & REGISTER -->
<main id="authBox">
  <!-- Login Card -->
  <div class="card">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <br><br>
    <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <br><br>
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Register Card -->
  <div class="card">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
    <input id="newEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <br><br>
    <input id="newPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <br><br>
    <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  </div>
</main>

<!-- APP -->
<main id="app" class="hidden">
  <div class="grid">

    <!-- DRIVER -->
    <div class="card" id="driverBox">
      <h3>ğŸ“· Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h3>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" hidden></canvas>
      <img id="preview" />
      <div class="row">
        <button onclick="capture()">Ø§Ù„ØªÙ‚Ø§Ø·</button>
        <button class="secondary" onclick="sendOperation()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <p style="font-size:13px;opacity:.7;text-align:center">â€» Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</p>
    </div>

    <!-- ADMIN -->
    <div class="card hidden" id="adminBox">
      <h3>ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <table style="width:100%;font-size:13px">
        <thead><tr><th>ØµÙˆØ±Ø©</th><th>ÙˆÙ‚Øª</th><th>OCR</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th></tr></thead>
        <tbody id="ops"></tbody>
      </table>
    </div>

  </div>

  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ 2025
  </footer>
</main>

<script>
/************** FIREBASE CONFIG **************/
const firebaseConfig = {
  apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
  authDomain: "tama-6219c.firebaseapp.com",
  databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
  projectId: "tama-6219c",
  appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/************** LOGIN **************/
function login() {
  const userEmail = document.getElementById('email').value.trim();
  const userPassword = document.getElementById('password').value.trim();

  if (!userEmail || !userPassword) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  auth.signInWithEmailAndPassword(userEmail, userPassword)
    .catch(e => alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + e.message));
}

/************** REGISTER **************/
function register() {
  const newEmail = document.getElementById('newEmail').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();

  if (!newEmail || !newPassword) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  auth.createUserWithEmailAndPassword(newEmail, newPassword)
    .then(cred => {
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒÙ€ driver
      db.ref('users/' + cred.user.uid).set({ role: 'driver', name: newEmail.split('@')[0] });  // Ø£Ø®Ø° Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      document.getElementById('newEmail').value = '';
      document.getElementById('newPassword').value = '';
    })
    .catch(err => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + err.message));
}

/************** AUTH STATE **************/
auth.onAuthStateChanged(async user => {
  if (!user) {
    authBox.classList.remove('hidden');
    app.classList.add('hidden');
    return;
  }
  authBox.classList.add('hidden');
  app.classList.remove('hidden');

  const snap = await db.ref('users/' + user.uid).get();
  const role = snap.val()?.role || 'driver';

  if (role === 'admin') {
    adminBox.classList.remove('hidden');
    driverBox.classList.add('hidden');
    loadAdmin();
  }
});

/************** CAMERA **************/
let stream;
navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
  stream = s; video.srcObject = s;
});

function capture() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  preview.src = canvas.toDataURL('image/jpeg', 0.9);
}

/************** SEND OP **************/
async function sendOperation() {
  if (!preview.src) return alert('Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©');

  // OCR â€“ Gemini Vision
  const ocr = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=AIzaSyC0JhoFGiCh102Q9X0y0xaWgFG-NQINWUk", {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{
        parts: [{ text: 'Ø§Ù‚Ø±Ø£ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©' }, { inline_data: { mime_type: 'image/jpeg', data: preview.src.split(',')[1] } }]
      }]
    })
  }).then(r => r.json());

  const text = ocr.candidates?.[0]?.content?.parts?.[0]?.text || '';

  // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const user = auth.currentUser;
  const userName = (await db.ref('users/' + user.uid).get()).val()?.name || 'Ù…Ø¬Ù‡ÙˆÙ„';

  db.ref('fuel_operations').push({
    image: preview.src,
    ocr: text,
    created: new Date().toISOString(),
    device: navigator.userAgent,
    userName: userName // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  });

  alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
}

/************** ADMIN **************/
function loadAdmin() {
  db.ref('fuel_operations').on('value', snap => {
    ops.innerHTML = '';
    snap.forEach(s => {
      const d = s.val();
      ops.innerHTML += `<tr><td><img src="${d.image}" height="50"></td><td>${d.created}</td><td>${d.ocr || ''}</td><td>${d.userName}</td></tr>`;
    });
  });
}
</script>

</body>
</html>
