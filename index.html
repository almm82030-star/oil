<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Proof | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.ibb.co/yFCW2v98/Untitled.webp">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #ef4444; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--t); line-height: 1.6; }
        
        header { background: var(--c); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--p); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-area img { height: 45px; border-radius: 8px; border: 1px solid var(--p); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .card { background: var(--c); padding: 25px; border-radius: 20px; border: 1px solid #334155; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 25px; }
        
        input, button { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 16px; outline: none; }
        button { background: var(--p); border: none; font-weight: 900; cursor: pointer; transition: 0.3s; }
        button:hover { filter: brightness(1.2); }
        .btn-sec { background: transparent; border: 2px solid var(--p); color: var(--p); }
        .btn-success { background: var(--s); }

        .captcha-wrapper { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px dashed var(--p); text-align: center; margin-bottom: 15px; }
        #captchaDisplay { font-size: 32px; font-weight: 900; color: var(--s); letter-spacing: 15px; user-select: none; font-style: italic; text-shadow: 2px 2px #000; }
        
        .hidden { display: none !important; }
        #video { width: 100%; max-width: 500px; border-radius: 20px; border: 4px solid var(--p); display: block; margin: 0 auto; }
        
        .table-res { overflow-x: auto; border-radius: 15px; background: #1e293b; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #0f172a; padding: 15px; color: var(--p); border-bottom: 2px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; text-align: center; }
        .badge { padding: 5px 12px; border-radius: 8px; font-weight: bold; background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <div>
            <div style="font-weight:900; color:var(--p); font-size: 18px;">FUEL PROOF</div>
            <div style="font-size:10px; color:#94a3b8;">Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</div>
        </div>
    </div>
    <div id="userLabel" style="font-size:12px; color:var(--s); font-weight: bold;"></div>
</header>

<div class="container">
    <section id="authPage">
        <div class="card" style="max-width:450px; margin: 40px auto;">
            <h2 id="authTitle" style="text-align:center; color:var(--p);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            
            <div id="loginGroup">
                <input type="text" id="userInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (honda@gmail.com)">
                <input type="password" id="passInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div class="captcha-wrapper">
                    <div id="captchaDisplay"></div>
                    <p style="font-size:10px; margin:5px 0 0 0; color: #94a3b8;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚</p>
                </div>
                <input type="text" id="capInp" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§">
                <button onclick="processLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                <button class="btn-sec" onclick="showRegister(true)">Ø³Ø¬Ù„ ÙƒÙ€Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="registerGroup" class="hidden">
                <input type="text" id="rName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚">
                <input type="text" id="rProj" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                <input type="text" id="rRegion" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
                <input type="text" id="rUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <input type="password" id="rPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-success" onclick="processRegister()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn-sec" onclick="showRegister(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <p id="authMsg" style="color:var(--d); text-align:center; font-size:13px;"></p>
        </div>
    </section>

    <section id="driverSec" class="hidden">
        <div class="card">
            <h3 style="margin:0 0 15px 0;">ğŸ“¸ ØªØµÙˆÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯</h3>
            <video id="video" autoplay playsinline></video>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <div onclick="snap('b')"><img id="picB" src="" style="width:100%; height:120px; border-radius:12px; background:#000; object-fit:cover; border:1px solid var(--p);"><button style="font-size:11px; margin-top:5px;">ØµÙˆØ±Ø© Ù‚Ø¨Ù„</button></div>
                <div onclick="snap('a')"><img id="picA" src="" style="width:100%; height:120px; border-radius:12px; background:#000; object-fit:cover; border:1px solid var(--p);"><button style="font-size:11px; margin-top:5px;">ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</button></div>
            </div>
            <button class="btn-success" style="margin-top:20px;" onclick="uploadData()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        </div>
    </section>

    <section id="adminSec" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
                <button onclick="location.reload()" style="width:auto; padding:5px 15px; font-size:12px;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div class="table-res">
                <table>
                    <thead><tr><th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø§Ù„ØµÙˆØ±</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
                    <tbody id="adminLogs"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>
const fbConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(fbConfig);
const fAuth = firebase.auth();
const fDb = firebase.database();

let currentCaptcha = "";
function setCaptcha() {
    currentCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('captchaDisplay').innerText = currentCaptcha;
}
setCaptcha(); // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„

function showRegister(val) {
    document.getElementById('loginGroup').classList.toggle('hidden', val);
    document.getElementById('registerGroup').classList.toggle('hidden', !val);
    document.getElementById('authTitle').innerText = val ? "ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
}

function processLogin() {
    const u = document.getElementById('userInp').value.trim();
    const p = document.getElementById('passInp').value.trim();
    const c = document.getElementById('capInp').value.trim();
    const msg = document.getElementById('authMsg');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ Ø£ÙˆÙ„Ø§Ù‹
    if(c !== currentCaptcha) {
        msg.innerText = "âŒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø®Ø·Ø£! ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯.";
        setCaptcha(); // ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        return;
    }

    const email = u.includes('@') ? u : `${u}@fuel.com`;
    fAuth.signInWithEmailAndPassword(email, p).then(res => {
        if(u === "honda@gmail.com" && p === "212775@#") {
            fDb.ref('users/' + res.user.uid).update({ role: 'admin' });
        }
        location.reload();
    }).catch(() => {
        msg.innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
    });
}

function processRegister() {
    const user = document.getElementById('rUser').value.trim();
    const pass = document.getElementById('rPass').value.trim();
    const name = document.getElementById('rName').value.trim();
    const proj = document.getElementById('rProj').value.trim();

    if(!user || !pass || !name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    fAuth.createUserWithEmailAndPassword(`${user}@fuel.com`, pass).then(res => {
        fDb.ref('users/' + res.user.uid).set({ name, project: proj, role: 'driver' });
        location.reload();
    }).catch(e => alert(e.message));
}

fAuth.onAuthStateChanged(user => {
    if(user) {
        fDb.ref('users/' + user.uid).once('value', snap => {
            const d = snap.val();
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('userLabel').innerText = `ğŸ‘¤ ${d.name}`;
            if(d.role === 'admin') {
                document.getElementById('adminSec').classList.remove('hidden');
                loadAdminData();
            } else {
                document.getElementById('driverSec').classList.remove('hidden');
                initCam();
            }
        });
    }
});

async function initCam() {
    try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = s;
    } catch(e) { alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
}

let imgB = null, imgA = null;
function snap(t) {
    const v = document.getElementById('video');
    const c = document.createElement('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.5);
    if(t === 'b') { imgB = data; document.getElementById('picB').src = data; }
    else { imgA = data; document.getElementById('picA').src = data; }
}

function uploadData() {
    if(!imgB || !imgA) return alert("Ø§Ù„ØªÙ‚Ø· Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹");
    navigator.geolocation.getCurrentPosition(pos => {
        fDb.ref('reports').push({
            driver: fAuth.currentUser.email.split('@')[0],
            imgB, imgA,
            lat: pos.coords.latitude, lng: pos.coords.longitude,
            time: new Date().toLocaleString('ar-SA')
        }).then(() => { alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); location.reload(); });
    }, () => alert("ÙØ¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ"), {enableHighAccuracy: true});
}

function loadAdminData() {
    fDb.ref('reports').on('value', snap => {
        let html = '';
        snap.forEach(child => {
            const v = child.val();
            html += `<tr>
                <td><b>${v.driver}</b></td>
                <td><a href="https://www.google.com/maps?q=${v.lat},${v.lng}" target="_blank" style="color:var(--s)">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
                <td><img src="${v.imgB}" width="40" style="border-radius:5px;"> <img src="${v.imgA}" width="40" style="border-radius:5px;"></td>
                <td><span class="badge">${v.time}</span></td>
            </tr>`;
        });
        document.getElementById('adminLogs').innerHTML = html || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    });
}
</script>
</body>
</html>
