<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Proof | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.ibb.co/yFCW2v98/Untitled.webp">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #ef4444; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--t); line-height: 1.6; -webkit-tap-highlight-color: transparent; }
        
        header { background: var(--c); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--p); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-area img { height: 45px; border-radius: 8px; border: 1px solid var(--p); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .card { background: var(--c); padding: 25px; border-radius: 20px; border: 1px solid #334155; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 25px; animation: fadeIn 0.5s ease; }
        
        input, button { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 16px; outline: none; }
        button { background: var(--p); border: none; font-weight: 900; cursor: pointer; transition: 0.3s; }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-sec { background: transparent; border: 2px solid var(--p); color: var(--p); }
        .btn-success { background: var(--s); }

        /* Captcha Design */
        .captcha-container { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px dashed var(--p); text-align: center; margin-bottom: 15px; }
        #captchaText { font-size: 32px; font-weight: 900; color: var(--s); letter-spacing: 15px; user-select: none; font-style: italic; text-shadow: 2px 2px #000; }
        
        .hidden { display: none !important; }
        #video { width: 100%; max-width: 500px; border-radius: 20px; border: 4px solid var(--p); display: block; margin: 0 auto; }
        
        /* Table Style */
        .table-res { overflow-x: auto; border-radius: 15px; background: #1e293b; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #0f172a; padding: 15px; color: var(--p); border-bottom: 2px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; text-align: center; }
        .badge { padding: 5px 12px; border-radius: 8px; font-weight: bold; background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <div>
            <div style="font-weight:900; color:var(--p); font-size: 18px;">FUEL PROOF</div>
            <div style="font-size:10px; color:#94a3b8;">Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</div>
        </div>
    </div>
    <div id="userLabel" style="font-size:12px; color:var(--s);"></div>
</header>

<div class="container">
    <section id="authPage">
        <div class="card" style="max-width:450px; margin: 40px auto;">
            <h2 id="title" style="text-align:center; color:var(--p);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            
            <div id="loginForm">
                <input type="text" id="userInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
                <input type="password" id="passInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div class="captcha-container">
                    <div id="captchaText"></div>
                    <p style="font-size:10px; margin:5px 0 0 0;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚</p>
                </div>
                <input type="text" id="capInp" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚">
                <button onclick="performLogin()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
                <button class="btn-sec" onclick="toggleAuth(true)">ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="regForm" class="hidden">
                <input type="text" id="rName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                <input type="text" id="rProj" placeholder="Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                <input type="text" id="rRegion" placeholder="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„">
                <input type="text" id="rUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±">
                <input type="password" id="rPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-success" onclick="performRegister()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
                <button class="btn-sec" onclick="toggleAuth(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <p id="msg" style="color:var(--d); text-align:center; font-weight:bold;"></p>
        </div>
    </section>

    <section id="driverSec" class="hidden">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“¸ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯</h3>
            <video id="video" autoplay playsinline></video>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <div onclick="takeSnap('b')"><img id="vB" src="" style="width:100%; height:120px; border-radius:12px; background:#000; object-fit:cover;"><button style="font-size:11px;">ØµÙˆØ±Ø© Ù‚Ø¨Ù„</button></div>
                <div onclick="takeSnap('a')"><img id="vA" src="" style="width:100%; height:120px; border-radius:12px; background:#000; object-fit:cover;"><button style="font-size:11px;">ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</button></div>
            </div>
            <button class="btn-success" style="margin-top:20px;" onclick="submitFinal()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø¯ÙŠØ±</button>
        </div>
    </section>

    <section id="adminSec" class="hidden">
        <div class="card">
            <h3>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©</h3>
            <div class="table-res">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th></tr>
                    </thead>
                    <tbody id="logs"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>
// Firebase Config
const fbConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(fbConfig);
const fAuth = firebase.auth();
const fDb = firebase.database();

let captchaVal = "";
function genCap() {
    captchaVal = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('captchaText').innerText = captchaVal;
}
genCap();

function toggleAuth(reg) {
    document.getElementById('loginForm').classList.toggle('hidden', reg);
    document.getElementById('regForm').classList.toggle('hidden', !reg);
    document.getElementById('title').innerText = reg ? "ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
}

function performLogin() {
    const user = document.getElementById('userInp').value;
    const pass = document.getElementById('passInp').value;
    const cap = document.getElementById('capInp').value;

    if(cap !== captchaVal) return alert("ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø®Ø·Ø£!");

    const email = user.includes('@') ? user : `${user}@fuel.com`;
    fAuth.signInWithEmailAndPassword(email, pass).then(u => {
        if(user === "honda@gmail.com" && pass === "212775@#") {
            fDb.ref('users/' + u.user.uid).update({ role: 'admin' });
        }
        location.reload();
    }).catch(e => alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"));
}

function performRegister() {
    const u = document.getElementById('rUser').value;
    const p = document.getElementById('rPass').value;
    const n = document.getElementById('rName').value;
    const pr = document.getElementById('rProj').value;
    const rg = document.getElementById('rRegion').value;

    fAuth.createUserWithEmailAndPassword(`${u}@fuel.com`, p).then(res => {
        fDb.ref('users/' + res.user.uid).set({ name: n, project: pr, region: rg, role: 'driver' });
        location.reload();
    }).catch(e => alert(e.message));
}

fAuth.onAuthStateChanged(user => {
    if(user) {
        fDb.ref('users/' + user.uid).once('value', s => {
            const d = s.val();
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('userLabel').innerText = `ğŸ‘¤ ${d.name}`;
            if(d.role === 'admin') {
                document.getElementById('adminSec').classList.remove('hidden');
                loadData();
            } else {
                document.getElementById('driverSec').classList.remove('hidden');
                initCamera();
            }
        });
    }
});

async function initCamera() {
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('video').srcObject = s;
}

let picB = null, picA = null;
function takeSnap(t) {
    const v = document.getElementById('video');
    const c = document.createElement('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.5);
    if(t === 'b') { picB = data; document.getElementById('vB').src = data; }
    else { picA = data; document.getElementById('vA').src = data; }
}

function submitFinal() {
    if(!picB || !picA) return alert("ØµÙˆØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹!");
    navigator.geolocation.getCurrentPosition(pos => {
        fDb.ref('reports').push({
            driver: fAuth.currentUser.email.split('@')[0],
            picB, picA,
            lat: pos.coords.latitude, lng: pos.coords.longitude,
            time: new Date().toLocaleString('ar-SA')
        }).then(() => { alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­"); location.reload(); });
    }, () => alert("ÙØ¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ"), { enableHighAccuracy: true });
}

function loadData() {
    fDb.ref('reports').on('value', s => {
        let h = '';
        s.forEach(child => {
            const v = child.val();
            h += `<tr>
                <td><b>${v.driver}</b></td>
                <td>--</td>
                <td><a href="https://maps.google.com/?q=${v.lat},${v.lng}" target="_blank" style="color:var(--s)">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
                <td><img src="${v.picB}" width="40"> <img src="${v.picA}" width="40"></td>
                <td><span class="badge">${v.time}</span></td>
            </tr>`;
        });
        document.getElementById('logs').innerHTML = h;
    });
}
</script>
</body>
</html>
