<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fuel Proof â€“ Zahrani Logistics</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    * {box-sizing:border-box;font-family:'Cairo',system-ui;}
    body {margin:0;background:#0b1220;color:#e5e7eb;display:flex;flex-direction:column;min-height:100vh;}
    header {background:#020617;padding:18px 24px;display:flex;align-items:center;gap:16px;justify-content:flex-start;}
    header img {height:64px;max-width:220px;object-fit:contain;}
    header h1 {font-size:18px;margin:0;flex-grow:1;}
    .header-buttons {display:flex;gap:10px;}

    main {padding:20px;max-width:1400px;margin:auto;flex:1;width:100%;}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;}
    .card {background:#020617;border-radius:18px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,.35);transition:transform .2s;}
    .card:hover {transform:translateY(-5px);}
    .card h3 {text-align:center;margin-top:0;font-size:18px;}

    input, select, textarea, button {border-radius:14px;padding:12px;border:none;font-size:14px;}
    input, select, textarea {width:100%;background:#020617;color:#e5e7eb;border:1px solid #334155;}
    input:focus, select:focus, textarea:focus {outline:none;border-color:#22c55e;}
    button {background:#22c55e;font-weight:800;cursor:pointer;color:#fff;transition:background .2s;}
    button:hover {background:#16a34a;}
    button.secondary {background:#334155;color:#e5e7eb;}
    button.logout-btn {background:#dc2626;}
    button.login-btn {background:#3b82f6;}
    button.warning-btn {background:#f59e0b;}
    button.danger-btn {background:#dc2626;}
    button.info-btn {background:#3b82f6;}
    button.success-btn {background:#22c55e;}

    video, canvas, img {width:100%;border-radius:14px;}
    .row {display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
    .hidden {display:none;}
    .photos-container {display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;}
    .photo-box {text-align:center;}
    .photo-box h4 {margin:10px 0;}
    .km-display {display:flex;justify-content:space-between;margin:15px 0;padding:10px;background:#1e293b;border-radius:10px;}
    .km-display div {text-align:center;}
    .km-value {font-size:24px;font-weight:bold;color:#22c55e;}
    .km-diff {font-size:18px;color:#f59e0b;}

    footer {text-align:center;opacity:.6;font-size:12px;margin:30px 0;}

    /* AUTH PAGES */
    .auth-page {display:flex;align-items:center;justify-content:center;min-height:80vh;width:100%;}
    .auth-container {max-width:500px;width:100%;}
    .auth-tabs {display:flex;margin-bottom:20px;border-bottom:2px solid #334155;}
    .auth-tab {flex:1;text-align:center;padding:12px;cursor:pointer;background:none;border:none;color:#94a3b8;font-weight:600;}
    .auth-tab.active {color:#22c55e;border-bottom:3px solid #22c55e;}
    .user-info {display:flex;align-items:center;gap:10px;color:#e5e7eb;font-size:14px;}

    /* ADMIN TABS */
    .admin-tabs {display:flex;margin-bottom:20px;border-bottom:2px solid #334155;}
    .admin-tab {flex:1;text-align:center;padding:12px;cursor:pointer;background:none;border:none;color:#94a3b8;font-weight:600;}
    .admin-tab.active {color:#22c55e;border-bottom:3px solid #22c55e;}

    /* FORM STYLES */
    .form-group {margin-bottom:15px;}
    .form-group label {display:block;margin-bottom:5px;color:#94a3b8;font-size:14px;}
    .form-row {display:grid;grid-template-columns:1fr 1fr;gap:15px;}

    /* TABLES */
    table {width:100%;border-collapse:collapse;margin-top:15px;}
    th {background:#1e293b;padding:12px;text-align:right;border-bottom:2px solid #334155;}
    td {padding:12px;border-bottom:1px solid #334155;text-align:center;}
    tr.suspicious {background:rgba(220,38,38,0.1);}
    tr.suspicious:hover {background:rgba(220,38,38,0.2);}
    .status-normal {color:#22c55e;}
    .status-suspicious {color:#dc2626;font-weight:bold;}
    .driver-avatar {width:40px;height:40px;border-radius:50%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;margin:0 auto;}
    
    /* BADGES */
    .badge {display:inline-block;padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;}
    .badge-success {background:#22c55e;color:white;}
    .badge-warning {background:#f59e0b;color:white;}
    .badge-danger {background:#dc2626;color:white;}
    .badge-info {background:#3b82f6;color:white;}
    
    /* DRIVER PROFILE */
    .driver-profile {display:flex;align-items:center;gap:15px;}
    .driver-avatar-large {width:60px;height:60px;border-radius:50%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;}
    .driver-info h4 {margin:0;font-size:16px;}
    .driver-info p {margin:5px 0;color:#94a3b8;font-size:14px;}
    
    /* STATS CARDS */
    .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;}
    .stat-card {background:#1e293b;padding:20px;border-radius:12px;text-align:center;}
    .stat-value {font-size:32px;font-weight:bold;margin:10px 0;}
    .stat-label {color:#94a3b8;font-size:14px;}
    
    /* CUSTOM ALERT */
    .custom-alert {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .custom-alert-content {background:#020617;border-radius:18px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 12px 32px rgba(0,0,0,0.5);position:relative;}
    .close-alert {position:absolute;top:15px;left:15px;background:#dc2626;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:16px;}
  </style>
</head>
<body>

<header>
  <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Fuel Proof">
  <h1>Fuel Proof System</h1>
  <div class="header-buttons" id="headerButtons">
    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
  </div>
</header>

<!-- AUTHENTICATION PAGE -->
<main id="authPage" class="auth-page">
  <div class="auth-container">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <!-- LOGIN FORM -->
    <div class="card" id="loginForm">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="form-group">
        <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
      </div>
      <div class="form-group">
        <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      </div>
      <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>
    
    <!-- REGISTER FORM -->
    <div class="card hidden" id="registerForm">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</h3>
      
      <!-- Ø§Ù„Ø§Ø³Ù… -->
      <div class="form-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
        <input id="driverName" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚" />
      </div>
      
      <!-- Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
        <input id="driverProject" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" />
      </div>
      
      <!-- Ø§Ù„Ù…Ù†Ø·Ù‚Ø© -->
      <div class="form-group">
        <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
        <select id="driverRegion" onchange="handleRegionChange()">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
          <option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
          <option value="Ø¬Ø¯Ø©">Ø¬Ø¯Ø©</option>
          <option value="Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©">Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©</option>
          <option value="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
          <option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
          <option value="Ø§Ù„Ø®Ø¨Ø±">Ø§Ù„Ø®Ø¨Ø±</option>
          <option value="other">Ø£Ø®Ø±Ù‰ (Ø£Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹)</option>
        </select>
        <input id="driverRegionCustom" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹" class="hidden" style="margin-top:10px;" />
      </div>
      
      <!-- Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
        <input id="vehicleType" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©" />
      </div>
      
      <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="newEmail" type="email" placeholder="example@email.com" />
      </div>
      
      <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="newPassword" type="password" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" />
      </div>
      
      <button onclick="registerDriver()" class="success-btn">ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
      <p style="text-align:center;font-size:12px;color:#94a3b8;margin-top:10px;">
        âš ï¸ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
      </p>
    </div>
  </div>
</main>

<!-- MAIN APP FOR DRIVER -->
<main id="app" class="hidden">
  <div class="card" id="driverBox">
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø´Ø®ØµÙŠØ© -->
    <div class="driver-profile" id="driverProfile">
      <div class="driver-avatar-large" id="driverAvatar">Ø³</div>
      <div class="driver-info">
        <h4 id="driverFullName">Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
        <p id="driverDetails">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: - | Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</p>
        <p id="driverVehicle" style="font-size:12px;color:#94a3b8;"></p>
      </div>
    </div>
    
    <h3 style="margin-top:20px;">ğŸ“· Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h3>
    
    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" hidden></canvas>
    
    <!-- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ -->
    <div class="photos-container">
      <div class="photo-box">
        <h4>ğŸ“¸ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h4>
        <img id="previewBefore" />
        <div id="kmBeforeDisplay" class="hidden">
          <div class="km-display">
            <div>Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª:<br><span class="km-value" id="kmBeforeValue">0</span></div>
          </div>
        </div>
      </div>
      
      <div class="photo-box">
        <h4>ğŸ“¸ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h4>
        <img id="previewAfter" />
        <div id="kmAfterDisplay" class="hidden">
          <div class="km-display">
            <div>Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª:<br><span class="km-value" id="kmAfterValue">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ù‚ -->
    <div id="kmDifferenceDisplay" class="hidden">
      <div class="km-display">
        <div>Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©:<br><span class="km-value" id="diffBefore">0</span></div>
        <div>Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©:<br><span class="km-value" id="diffAfter">0</span></div>
        <div>Ø§Ù„ÙØ±Ù‚:<br><span class="km-diff" id="diffResult">0</span></div>
      </div>
    </div>
    
    <div class="row">
      <button onclick="captureBefore()">Ø§Ù„ØªÙ‚Ø§Ø· Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</button>
      <button onclick="captureAfter()">Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</button>
      <button class="secondary" onclick="sendOperation()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>
    
    <div id="operationStatus" style="text-align:center;margin-top:15px;"></div>
    
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div class="stats-grid" id="driverStats">
      <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="stat-value" id="totalOperationsDriver">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="stat-value" id="monthlyOperations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ±Ù‚</div>
        <div class="stat-value" id="avgDifferenceDriver">0 ÙƒÙ…</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©</div>
        <div class="stat-value" style="font-size:18px;" id="lastOperationDate">-</div>
      </div>
    </div>
  </div>
</main>

<!-- ADMIN DASHBOARD -->
<main id="adminDashboard" class="hidden">
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="switchAdminTab('operations')">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
    <button class="admin-tab" onclick="switchAdminTab('suspicious')">Ø§Ù„ØªØ¹Ø¨Ø¦Ø§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©</button>
    <button class="admin-tab" onclick="switchAdminTab('drivers')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</button>
    <button class="admin-tab" onclick="switchAdminTab('analysis')">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
  </div>
  
  <!-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
  <div id="operationsTab" class="card">
    <h3>ğŸ§¾ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="stat-value" id="totalOperationsAdmin">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="stat-value" id="todayOperations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="stat-value" id="monthlyOperationsAdmin">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©</div>
        <div class="stat-value" id="suspiciousOperations">0</div>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
          <th>Ø§Ù„ØµÙˆØ±</th>
          <th>Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª</th>
          <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody id="operationsList"></tbody>
    </table>
  </div>
  
  <!-- Ø§Ù„ØªØ¹Ø¨Ø¦Ø§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø© -->
  <div id="suspiciousTab" class="card hidden">
    <h3>âš ï¸ Ø§Ù„ØªØ¹Ø¨Ø¦Ø§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div>
        <span style="color:#dc2626;font-weight:bold;" id="suspiciousCount">0</span> Ø¹Ù…Ù„ÙŠØ© Ù…Ø´Ø¨ÙˆÙ‡Ø©
      </div>
      <button class="danger-btn" onclick="markAllResolved()">ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ„ ÙƒÙ€ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</button>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
          <th>Ø§Ù„ØµÙˆØ±</th>
          <th>Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª</th>
          <th>Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="suspiciousList"></tbody>
    </table>
  </div>
  
  <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† -->
  <div id="driversTab" class="card hidden">
    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div>
        <span style="color:#22c55e;font-weight:bold;" id="totalDrivers">0</span> Ø³Ø§Ø¦Ù‚ Ù…Ø³Ø¬Ù„
      </div>
      <button class="info-btn" onclick="exportDriversData()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
          <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
          <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="driversList"></tbody>
    </table>
  </div>
  
  <!-- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div id="analysisTab" class="card hidden">
    <h3>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;">
      <div style="background:#1e293b;padding:20px;border-radius:12px;">
        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
        <div style="font-size:36px;color:#22c55e;font-weight:bold;" id="totalOperationsStats">0</div>
      </div>
      <div style="background:#1e293b;padding:20px;border-radius:12px;">
        <h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø§Øª</h4>
        <div style="font-size:36px;color:#dc2626;font-weight:bold;" id="suspiciousPercentage">0%</div>
      </div>
      <div style="background:#1e293b;padding:20px;border-radius:12px;">
        <h4>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ±Ù‚</h4>
        <div style="font-size:36px;color:#f59e0b;font-weight:bold;" id="avgDifferenceStats">0 ÙƒÙ…</div>
      </div>
      <div style="background:#1e293b;padding:20px;border-radius:12px;">
        <h4>Ø£ÙƒØ«Ø± Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÙŠØ§Øª</h4>
        <div style="font-size:20px;color:#3b82f6;" id="topProject">-</div>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div>
        <h4>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h4>
        <div id="regionDistribution" style="height:300px;background:#1e293b;border-radius:12px;padding:15px;">
          <!-- Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù‡Ù†Ø§ -->
        </div>
      </div>
      <div>
        <h4>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h4>
        <div id="projectDistribution" style="height:300px;background:#1e293b;border-radius:12px;padding:15px;">
          <!-- Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù‡Ù†Ø§ -->
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ 2025
</footer>

<script>
/************** FIREBASE CONFIG **************/
const firebaseConfig = {
  apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
  authDomain: "tama-6219c.firebaseapp.com",
  databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
  projectId: "tama-6219c",
  appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/************** Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… **************/
let stream;
let currentPhotoType = 'before';
let beforeImageData = null;
let afterImageData = null;
let kmBefore = 0;
let kmAfter = 0;
let currentDriverProfile = null;

/************** AUTH TABS **************/
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'login') {
    document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
  } else {
    document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
  }
}

/************** ADMIN TABS **************/
function switchAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  
  document.getElementById('operationsTab').classList.add('hidden');
  document.getElementById('suspiciousTab').classList.add('hidden');
  document.getElementById('driversTab').classList.add('hidden');
  document.getElementById('analysisTab').classList.add('hidden');
  
  if (tab === 'operations') {
    document.querySelector('.admin-tab:nth-child(1)').classList.add('active');
    document.getElementById('operationsTab').classList.remove('hidden');
    loadAdminOperations();
  } else if (tab === 'suspicious') {
    document.querySelector('.admin-tab:nth-child(2)').classList.add('active');
    document.getElementById('suspiciousTab').classList.remove('hidden');
    loadSuspiciousOperations();
  } else if (tab === 'drivers') {
    document.querySelector('.admin-tab:nth-child(3)').classList.add('active');
    document.getElementById('driversTab').classList.remove('hidden');
    loadDriversManagement();
  } else if (tab === 'analysis') {
    document.querySelector('.admin-tab:nth-child(4)').classList.add('active');
    document.getElementById('analysisTab').classList.remove('hidden');
    loadAnalysis();
  }
}

/************** HANDLE REGION CHANGE **************/
function handleRegionChange() {
  const regionSelect = document.getElementById('driverRegion');
  const customRegionInput = document.getElementById('driverRegionCustom');
  
  if (regionSelect.value === 'other') {
    customRegionInput.classList.remove('hidden');
    customRegionInput.value = '';
    customRegionInput.focus();
  } else {
    customRegionInput.classList.add('hidden');
    customRegionInput.value = '';
  }
}

/************** UPDATE HEADER **************/
function updateHeader(user, userData) {
  const headerButtons = document.getElementById('headerButtons');
  headerButtons.innerHTML = '';
  
  if (!user) return;
  
  const userInfo = document.createElement('div');
  userInfo.className = 'user-info';
  
  let userName = userData?.name || user.email?.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…';
  let userRole = userData?.role === 'admin' ? ' (Ù…Ø¯ÙŠØ±)' : ' (Ø³Ø§Ø¦Ù‚)';
  
  userInfo.innerHTML = `<span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}${userRole}</span>`;
  
  const logoutBtn = document.createElement('button');
  logoutBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
  logoutBtn.className = 'logout-btn';
  logoutBtn.onclick = () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      auth.signOut();
    }
  };
  
  headerButtons.appendChild(userInfo);
  headerButtons.appendChild(logoutBtn);
}

/************** PAGE NAVIGATION **************/
function showAuthPage() {
  document.getElementById('authPage').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('adminDashboard').classList.add('hidden');
  switchAuthTab('login');
}

function showDriverApp(userData) {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('adminDashboard').classList.add('hidden');
  updateDriverProfile(userData);
  loadDriverStats();
  startCamera();
}

function showAdminDashboard() {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
  loadAdminOperations();
}

/************** UPDATE DRIVER PROFILE **************/
function updateDriverProfile(userData) {
  currentDriverProfile = userData;
  
  const avatar = document.getElementById('driverAvatar');
  const fullName = document.getElementById('driverFullName');
  const details = document.getElementById('driverDetails');
  const vehicle = document.getElementById('driverVehicle');
  
  if (userData.name) {
    const firstName = userData.name.split(' ')[0];
    avatar.textContent = firstName.charAt(0);
    fullName.textContent = userData.name;
  } else {
    avatar.textContent = 'Ø³';
    fullName.textContent = userData.email?.split('@')[0] || 'Ø§Ù„Ø³Ø§Ø¦Ù‚';
  }
  
  const project = userData.project || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const region = userData.region || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
  details.textContent = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${project} | Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${region}`;
  
  if (userData.vehicleType) {
    vehicle.textContent = `ğŸš— ${userData.vehicleType}`;
  } else {
    vehicle.textContent = '';
  }
}

/************** LOGIN **************/
function login() {
  const userEmail = document.getElementById('email').value.trim();
  const userPassword = document.getElementById('password').value.trim();

  if (!userEmail || !userPassword) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  auth.signInWithEmailAndPassword(userEmail, userPassword)
    .then(() => {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    })
    .catch(e => alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + e.message));
}

/************** REGISTER DRIVER **************/
function registerDriver() {
  const name = document.getElementById('driverName').value.trim();
  const project = document.getElementById('driverProject').value.trim();
  const regionSelect = document.getElementById('driverRegion').value;
  const customRegion = document.getElementById('driverRegionCustom').value.trim();
  const vehicle = document.getElementById('vehicleType').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const password = document.getElementById('newPassword').value.trim();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (!name) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚');
  }

  if (!project) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
  }

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
  let region;
  if (regionSelect === 'other') {
    if (!customRegion) {
      return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹');
    }
    region = customRegion;
  } else if (!regionSelect) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
  } else {
    region = regionSelect;
  }

  if (!vehicle) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©');
  }

  if (!email) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
  }

  if (!password) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  if (password.length < 6) {
    return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  auth.createUserWithEmailAndPassword(email, password)
    .then(cred => {
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      const driverData = {
        role: 'driver',
        email: email,
        name: name,
        project: project,
        region: region,
        vehicleType: vehicle,
        status: 'active',
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
      };
      
      return db.ref('users/' + cred.user.uid).set(driverData);
    })
    .then(() => {
      alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('driverName').value = '';
      document.getElementById('driverProject').value = '';
      document.getElementById('driverRegion').value = '';
      document.getElementById('driverRegionCustom').value = '';
      document.getElementById('driverRegionCustom').classList.add('hidden');
      document.getElementById('vehicleType').value = '';
      document.getElementById('newEmail').value = '';
      document.getElementById('newPassword').value = '';
      
      // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      switchAuthTab('login');
    })
    .catch(err => {
      if (err.code === 'auth/email-already-in-use') {
        alert('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      } else {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + err.message);
      }
    });
}

/************** AUTH STATE **************/
auth.onAuthStateChanged(async user => {
  if (!user) {
    updateHeader(null, null);
    showAuthPage();
    return;
  }
  
  const snap = await db.ref('users/' + user.uid).get();
  const userData = snap.val();
  
  if (!userData) {
    alert('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    auth.signOut();
    return;
  }
  
  updateHeader(user, userData);
  
  // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
  db.ref('users/' + user.uid).update({
    lastLogin: new Date().toISOString()
  });
  
  if (userData.role === 'admin') {
    showAdminDashboard();
  } else {
    showDriverApp(userData);
  }
});

/************** CAMERA **************/
function startCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(s => {
      stream = s; 
      document.getElementById('video').srcObject = s;
    })
    .catch(err => {
      console.log('Camera error:', err);
      alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
    });
}

/************** CAPTURE PHOTOS **************/
function captureBefore() {
  currentPhotoType = 'before';
  capturePhoto();
}

function captureAfter() {
  currentPhotoType = 'after';
  capturePhoto();
}

function capturePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  
  if (!video.videoWidth) {
    return alert('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹');
  }
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  
  const imageData = canvas.toDataURL('image/jpeg', 0.9);
  
  if (currentPhotoType === 'before') {
    document.getElementById('previewBefore').src = imageData;
    beforeImageData = imageData;
    extractKilometersFromImage(imageData, 'before');
  } else {
    document.getElementById('previewAfter').src = imageData;
    afterImageData = imageData;
    extractKilometersFromImage(imageData, 'after');
  }
}

/************** EXTRACT KILOMETERS USING AI **************/
async function extractKilometersFromImage(imageData, type) {
  const statusElement = document.getElementById('operationStatus');
  statusElement.innerHTML = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...';
  statusElement.style.color = '#f59e0b';
  
  try {
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=AIzaSyC0JhoFGiCh102Q9X0y0xaWgFG-NQINWUk", {
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { 
              text: 'Ø£Ø±ÙŠØ¯ ÙÙ‚Ø· Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ù…Ù† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©. \n' +
                    'ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¢Ø®Ø±. \n' +
                    'Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… 12345ØŒ Ø£Ø±Ø¬Ø¹Ù‡ ÙƒÙ€ 12345 ÙÙ‚Ø·. \n' +
                    'Ø¥Ø°Ø§ Ù„Ù… ØªØ³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù‚Ù…ØŒ Ø£Ø±Ø¬Ø­ "0" ÙÙ‚Ø·.'
            }, 
            { inline_data: { mime_type: 'image/jpeg', data: imageData.split(',')[1] } }
          ]
        }]
      })
    });
    
    const result = await response.json();
    let kmText = result.candidates?.[0]?.content?.parts?.[0]?.text || '0';
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    kmText = kmText.replace(/[^\d]/g, '');
    const kmValue = parseInt(kmText) || 0;
    
    if (type === 'before') {
      kmBefore = kmValue;
      document.getElementById('kmBeforeValue').textContent = kmValue.toLocaleString();
      document.getElementById('kmBeforeDisplay').classList.remove('hidden');
      statusElement.innerHTML = 'âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©: ' + kmValue.toLocaleString();
    } else {
      kmAfter = kmValue;
      document.getElementById('kmAfterValue').textContent = kmValue.toLocaleString();
      document.getElementById('kmAfterDisplay').classList.remove('hidden');
      statusElement.innerHTML = 'âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©: ' + kmValue.toLocaleString();
    }
    
    statusElement.style.color = '#22c55e';
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…ØªØ§Ù†ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚
    if (kmBefore > 0 && kmAfter > 0) {
      calculateAndDisplayDifference();
    }
    
  } catch (error) {
    console.error('OCR Error:', error);
    statusElement.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª';
    statusElement.style.color = '#dc2626';
    
    if (type === 'before') {
      kmBefore = 0;
    } else {
      kmAfter = 0;
    }
  }
}

/************** CALCULATE DIFFERENCE **************/
function calculateAndDisplayDifference() {
  const diff = kmAfter - kmBefore;
  
  document.getElementById('diffBefore').textContent = kmBefore.toLocaleString();
  document.getElementById('diffAfter').textContent = kmAfter.toLocaleString();
  document.getElementById('diffResult').textContent = diff.toLocaleString() + ' ÙƒÙ…';
  
  document.getElementById('kmDifferenceDisplay').classList.remove('hidden');
  
  const statusElement = document.getElementById('operationStatus');
  if (diff < 0) {
    statusElement.innerHTML = 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø£Ù‚Ù„ Ù…Ù† Ù‚Ø¨Ù„Ù‡Ø§!';
    statusElement.style.color = '#dc2626';
  } else if (diff === 0) {
    statusElement.innerHTML = 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ ÙÙŠ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª';
    statusElement.style.color = '#f59e0b';
  } else if (diff > 100) {
    statusElement.innerHTML = 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙØ±Ù‚ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (' + diff + ' ÙƒÙ…)';
    statusElement.style.color = '#f59e0b';
  } else {
    statusElement.innerHTML = 'âœ… Ø§Ù„ÙØ±Ù‚: ' + diff + ' ÙƒÙ…';
    statusElement.style.color = '#22c55e';
  }
}

/************** SEND OPERATION **************/
async function sendOperation() {
  if (!beforeImageData || !afterImageData) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±ØªÙŠÙ† (Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©)');
  }
  
  if (kmBefore === 0 || kmAfter === 0) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ù…Ù† Ø§Ù„ØµÙˆØ±');
  }
  
  const user = auth.currentUser;
  if (!user) {
    alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  const statusElement = document.getElementById('operationStatus');
  statusElement.innerHTML = 'ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...';
  statusElement.style.color = '#3b82f6';
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙˆØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø´Ø¨ÙˆÙ‡Ø©
  const diff = kmAfter - kmBefore;
  const isSuspicious = checkIfSuspicious(diff, kmBefore, kmAfter);
  const suspicionReason = isSuspicious ? getSuspicionReason(diff, kmBefore, kmAfter) : '';
  
  // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const operationData = {
    beforeImage: beforeImageData,
    afterImage: afterImageData,
    kmBefore: kmBefore,
    kmAfter: kmAfter,
    kmDifference: diff,
    isSuspicious: isSuspicious,
    suspicionReason: suspicionReason,
    userId: user.uid,
    userEmail: user.email,
    userName: currentDriverProfile ? currentDriverProfile.name : user.email.split('@')[0],
    userProject: currentDriverProfile ? currentDriverProfile.project : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    userRegion: currentDriverProfile ? currentDriverProfile.region : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©',
    userVehicle: currentDriverProfile ? currentDriverProfile.vehicleType : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    createdAt: new Date().toISOString(),
    status: isSuspicious ? 'Ù…Ø´Ø¨ÙˆÙ‡Ø©' : 'Ø·Ø¨ÙŠØ¹ÙŠØ©'
  };
  
  db.ref('fuel_operations').push(operationData)
    .then(() => {
      statusElement.innerHTML = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!';
      statusElement.style.color = '#22c55e';
      
      if (isSuspicious) {
        statusElement.innerHTML += '<br>âš ï¸ ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø§Øª Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚';
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      resetOperationForm();
      loadDriverStats();
    })
    .catch(error => {
      console.error('Error saving operation:', error);
      statusElement.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
      statusElement.style.color = '#dc2626';
    });
}

/************** SUSPICIOUS OPERATION DETECTION **************/
function checkIfSuspicious(diff, kmBefore, kmAfter) {
  if (diff < 0) return true;
  if (diff === 0) return true;
  if (diff > 100) return true;
  if (kmBefore < 0 || kmAfter < 0 || kmBefore > 1000000 || kmAfter > 1000000) return true;
  if (isNaN(diff) || isNaN(kmBefore) || isNaN(kmAfter)) return true;
  return false;
}

function getSuspicionReason(diff, kmBefore, kmAfter) {
  if (diff < 0) return 'Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø£Ù‚Ù„ Ù…Ù† Ù‚Ø¨Ù„Ù‡Ø§';
  if (diff === 0) return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ ÙÙŠ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª';
  if (diff > 100) return 'Ø§Ù„ÙØ±Ù‚ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (' + diff + ' ÙƒÙ…)';
  if (kmBefore < 0 || kmAfter < 0) return 'Ù‚ÙŠÙ… ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø³Ø§Ù„Ø¨Ø©';
  if (kmBefore > 1000000 || kmAfter > 1000000) return 'Ù‚ÙŠÙ… ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ©';
  if (isNaN(diff) || isNaN(kmBefore) || isNaN(kmAfter)) return 'Ù‚ÙŠÙ… ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ©';
  return 'Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
}

/************** RESET OPERATION FORM **************/
function resetOperationForm() {
  document.getElementById('previewBefore').src = '';
  document.getElementById('previewAfter').src = '';
  document.getElementById('kmBeforeDisplay').classList.add('hidden');
  document.getElementById('kmAfterDisplay').classList.add('hidden');
  document.getElementById('kmDifferenceDisplay').classList.add('hidden');
  
  beforeImageData = null;
  afterImageData = null;
  kmBefore = 0;
  kmAfter = 0;
  
  setTimeout(() => {
    document.getElementById('operationStatus').innerHTML = '';
  }, 5000);
}

/************** LOAD DRIVER STATS **************/
function loadDriverStats() {
  const user = auth.currentUser;
  if (!user || !user.uid) return;
  
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  
  // Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø´Ø®ØµÙŠØ©
  db.ref('fuel_operations').orderByChild('userId').equalTo(user.uid).on('value', snap => {
    if (!snap.exists()) {
      document.getElementById('totalOperationsDriver').textContent = '0';
      document.getElementById('monthlyOperations').textContent = '0';
      document.getElementById('avgDifferenceDriver').textContent = '0 ÙƒÙ…';
      document.getElementById('lastOperationDate').textContent = '-';
      return;
    }
    
    let total = 0;
    let monthlyCount = 0;
    let totalDiff = 0;
    let lastDate = null;
    
    snap.forEach(child => {
      const op = child.val();
      total++;
      
      if (op.createdAt >= startOfMonth) {
        monthlyCount++;
      }
      
      if (op.kmDifference) {
        totalDiff += op.kmDifference;
      }
      
      if (!lastDate || op.createdAt > lastDate) {
        lastDate = op.createdAt;
      }
    });
    
    const avgDiff = total > 0 ? Math.round(totalDiff / total) : 0;
    const lastOpDate = lastDate ? new Date(lastDate).toLocaleDateString('ar-SA') : '-';
    
    document.getElementById('totalOperationsDriver').textContent = total;
    document.getElementById('monthlyOperations').textContent = monthlyCount;
    document.getElementById('avgDifferenceDriver').textContent = avgDiff + ' ÙƒÙ…';
    document.getElementById('lastOperationDate').textContent = lastOpDate;
  });
}

/************** ADMIN FUNCTIONS **************/
function loadAdminOperations() {
  db.ref('fuel_operations').orderByChild('createdAt').limitToLast(100).on('value', snap => {
    const operationsList = document.getElementById('operationsList');
    operationsList.innerHTML = '';
    
    if (!snap.exists()) {
      operationsList.innerHTML = '<tr><td colspan="6" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
      updateAdminStats(0, 0, 0, 0);
      return;
    }
    
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
    
    let total = 0;
    let todayCount = 0;
    let monthlyCount = 0;
    let suspiciousCount = 0;
    const operations = [];
    
    snap.forEach(child => {
      const op = child.val();
      operations.push({ id: child.key, ...op });
      total++;
      
      if (op.createdAt >= today) todayCount++;
      if (op.createdAt >= startOfMonth) monthlyCount++;
      if (op.isSuspicious) suspiciousCount++;
    });
    
    updateAdminStats(total, todayCount, monthlyCount, suspiciousCount);
    
    operations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    operations.forEach(op => {
      const date = new Date(op.createdAt);
      const formattedDate = date.toLocaleString('ar-SA');
      const statusClass = op.isSuspicious ? 'status-suspicious' : 'status-normal';
      const driverInitial = op.userName ? op.userName.charAt(0) : 'Ø³';
      
      operationsList.innerHTML += `
        <tr class="${op.isSuspicious ? 'suspicious' : ''}">
          <td>
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="driver-avatar">${driverInitial}</div>
              <div style="text-align:right;">
                <div style="font-weight:bold;">${op.userName || op.userEmail || 'Ù…Ø¬Ù‡ÙˆÙ„'}</div>
                <small style="color:#94a3b8;">${op.userVehicle || ''}</small>
              </div>
            </div>
          </td>
          <td>
            <div style="display:flex;gap:5px;">
              <img src="${op.beforeImage}" height="40" style="border-radius:5px;cursor:pointer" 
                   onclick="window.open('${op.beforeImage}')" title="Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©">
              <img src="${op.afterImage}" height="40" style="border-radius:5px;cursor:pointer" 
                   onclick="window.open('${op.afterImage}')" title="Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©">
            </div>
          </td>
          <td>
            <div style="text-align:right;">
              <div>Ù‚Ø¨Ù„: <strong>${op.kmBefore?.toLocaleString() || '0'}</strong></div>
              <div>Ø¨Ø¹Ø¯: <strong>${op.kmAfter?.toLocaleString() || '0'}</strong></div>
              <div>Ø§Ù„ÙØ±Ù‚: <strong style="color:#f59e0b">${op.kmDifference?.toLocaleString() || '0'} ÙƒÙ…</strong></div>
            </div>
          </td>
          <td>
            <div style="text-align:right;">
              <div><strong>${op.userProject || '-'}</strong></div>
              <div><small>${op.userRegion || '-'}</small></div>
            </div>
          </td>
          <td>${formattedDate}</td>
          <td><span class="${statusClass}">${op.status || 'Ø·Ø¨ÙŠØ¹ÙŠØ©'}</span></td>
        </tr>
      `;
    });
  });
}

function updateAdminStats(total, today, monthly, suspicious) {
  document.getElementById('totalOperationsAdmin').textContent = total;
  document.getElementById('todayOperations').textContent = today;
  document.getElementById('monthlyOperationsAdmin').textContent = monthly;
  document.getElementById('suspiciousOperations').textContent = suspicious;
}

function loadSuspiciousOperations() {
  db.ref('fuel_operations').orderByChild('isSuspicious').equalTo(true).on('value', snap => {
    const suspiciousList = document.getElementById('suspiciousList');
    suspiciousList.innerHTML = '';
    
    if (!snap.exists()) {
      suspiciousList.innerHTML = '<tr><td colspan="6" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¨Ø¦Ø§Øª Ù…Ø´Ø¨ÙˆÙ‡Ø©</td></tr>';
      document.getElementById('suspiciousCount').textContent = '0';
      return;
    }
    
    const operations = [];
    snap.forEach(child => {
      operations.push({ id: child.key, ...child.val() });
    });
    
    document.getElementById('suspiciousCount').textContent = operations.length;
    
    operations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    operations.forEach(op => {
      const date = new Date(op.createdAt);
      const formattedDate = date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
      const driverInitial = op.userName ? op.userName.charAt(0) : 'Ø³';
      
      suspiciousList.innerHTML += `
        <tr class="suspicious">
          <td>
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="driver-avatar">${driverInitial}</div>
              <div style="text-align:right;">
                <div style="font-weight:bold;">${op.userName || op.userEmail || 'Ù…Ø¬Ù‡ÙˆÙ„'}</div>
                <small style="color:#94a3b8;">${op.userProject || '-'}</small>
              </div>
            </div>
          </td>
          <td>
            <div style="display:flex;gap:5px;">
              <img src="${op.beforeImage}" height="40" style="border-radius:5px;cursor:pointer" 
                   onclick="window.open('${op.beforeImage}')">
              <img src="${op.afterImage}" height="40" style="border-radius:5px;cursor:pointer" 
                   onclick="window.open('${op.afterImage}')">
            </div>
          </td>
          <td>
            <div style="text-align:right;">
              <div>Ù‚Ø¨Ù„: <strong>${op.kmBefore?.toLocaleString() || '0'}</strong></div>
              <div>Ø¨Ø¹Ø¯: <strong>${op.kmAfter?.toLocaleString() || '0'}</strong></div>
              <div>Ø§Ù„ÙØ±Ù‚: <strong style="color:#dc2626">${op.kmDifference?.toLocaleString() || '0'} ÙƒÙ…</strong></div>
            </div>
          </td>
          <td style="max-width:200px;">${op.suspicionReason || 'Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
          <td>${formattedDate}</td>
          <td>
            <div style="display:flex;gap:5px;justify-content:center;">
              <button class="success-btn" style="padding:5px 10px;font-size:12px;" 
                      onclick="markAsResolved('${op.id}')">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</button>
              <button class="danger-btn" style="padding:5px 10px;font-size:12px;" 
                      onclick="deleteOperation('${op.id}')">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `;
    });
  });
}

function markAsResolved(operationId) {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙˆØ¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙƒÙ€ "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠÙ‡Ø§"ØŸ')) {
    db.ref('fuel_operations/' + operationId).update({
      isSuspicious: false,
      status: 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚',
      reviewedAt: new Date().toISOString(),
      reviewedBy: auth.currentUser.email
    }).then(() => {
      alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    }).catch(error => {
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + error.message);
    });
  }
}

function markAllResolved() {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙˆØ¶Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø© ÙƒÙ€ "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠÙ‡Ø§"ØŸ')) {
    db.ref('fuel_operations').orderByChild('isSuspicious').equalTo(true).once('value').then(snap => {
      const updates = {};
      snap.forEach(child => {
        updates[child.key + '/isSuspicious'] = false;
        updates[child.key + '/status'] = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚';
        updates[child.key + '/reviewedAt'] = new Date().toISOString();
        updates[child.key + '/reviewedBy'] = auth.currentUser.email;
      });
      
      db.ref('fuel_operations').update(updates).then(() => {
        alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©');
      }).catch(error => {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ' + error.message);
      });
    });
  }
}

function deleteOperation(operationId) {
  if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
    db.ref('fuel_operations/' + operationId).remove()
      .then(() => {
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
      })
      .catch(error => {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + error.message);
      });
  }
}

/************** DRIVERS MANAGEMENT **************/
function loadDriversManagement() {
  db.ref('users').orderByChild('role').equalTo('driver').on('value', snap => {
    const driversList = document.getElementById('driversList');
    driversList.innerHTML = '';
    
    if (!snap.exists()) {
      driversList.innerHTML = '<tr><td colspan="7" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</td></tr>';
      document.getElementById('totalDrivers').textContent = '0';
      return;
    }
    
    const drivers = [];
    snap.forEach(child => {
      drivers.push({ id: child.key, ...child.val() });
    });
    
    document.getElementById('totalDrivers').textContent = drivers.length;
    
    drivers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    drivers.forEach(driver => {
      // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
      let operationsCount = 0;
      db.ref('fuel_operations').orderByChild('userId').equalTo(driver.id).once('value').then(opSnap => {
        operationsCount = opSnap.exists() ? opSnap.numChildren() : 0;
        
        const date = new Date(driver.createdAt);
        const formattedDate = date.toLocaleDateString('ar-SA');
        const driverInitial = driver.name ? driver.name.charAt(0) : driver.email.charAt(0);
        
        driversList.innerHTML += `
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:10px;">
                <div class="driver-avatar">${driverInitial}</div>
                <div style="text-align:right;">
                  <div style="font-weight:bold;">${driver.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                  <small style="color:#94a3b8;">${driver.email}</small>
                </div>
              </div>
            </td>
            <td>
              <div style="text-align:right;">
                <div><strong>${driver.project || '-'}</strong></div>
                <div><small>${driver.region || '-'}</small></div>
              </div>
            </td>
            <td>
              <div style="text-align:right;">
                ${driver.vehicleType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
              </div>
            </td>
            <td>${formattedDate}</td>
            <td>
              <span class="badge ${operationsCount > 0 ? 'badge-success' : 'badge-warning'}">
                ${operationsCount} Ø¹Ù…Ù„ÙŠØ©
              </span>
            </td>
            <td>
              <span class="badge ${driver.status === 'active' ? 'badge-success' : 'badge-danger'}">
                ${driver.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
              </span>
            </td>
            <td>
              <div style="display:flex;gap:5px;justify-content:center;">
                <button class="info-btn" style="padding:5px 10px;font-size:12px;" 
                        onclick="viewDriverDetails('${driver.id}')">Ø¹Ø±Ø¶</button>
                <button class="warning-btn" style="padding:5px 10px;font-size:12px;" 
                        onclick="editDriver('${driver.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="danger-btn" style="padding:5px 10px;font-size:12px;" 
                        onclick="toggleDriverStatus('${driver.id}', '${driver.status}')">
                  ${driver.status === 'active' ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                </button>
              </div>
            </td>
          </tr>
        `;
      });
    });
  });
}

function viewDriverDetails(driverId) {
  db.ref('users/' + driverId).once('value').then(snap => {
    const driver = snap.val();
    if (!driver) return;
    
    let details = `
      <div style="text-align:right;padding:20px;">
        <h3 style="margin-top:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
        <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
          <div class="driver-avatar-large">${driver.name ? driver.name.charAt(0) : driver.email.charAt(0)}</div>
          <div>
            <h4 style="margin:0;">${driver.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h4>
            <p style="color:#94a3b8;margin:5px 0;">${driver.email}</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
          <div style="background:#1e293b;padding:15px;border-radius:10px;">
            <div style="color:#94a3b8;font-size:14px;">ğŸ¢ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
            <div style="font-weight:bold;">${driver.project || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
          </div>
          <div style="background:#1e293b;padding:15px;border-radius:10px;">
            <div style="color:#94a3b8;font-size:14px;">ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
            <div style="font-weight:bold;">${driver.region || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}</div>
          </div>
          <div style="background:#1e293b;padding:15px;border-radius:10px;">
            <div style="color:#94a3b8;font-size:14px;">ğŸš— Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
            <div style="font-weight:bold;">${driver.vehicleType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
          </div>
          <div style="background:#1e293b;padding:15px;border-radius:10px;">
            <div style="color:#94a3b8;font-size:14px;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
            <div style="font-weight:bold;">${new Date(driver.createdAt).toLocaleDateString('ar-SA')}</div>
          </div>
        </div>
        
        <div style="margin-top:20px;">
          <button class="success-btn" onclick="viewDriverOperations('${driverId}')">Ø¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
        </div>
      </div>
    `;
    
    showCustomAlert(details);
  });
}

function viewDriverOperations(driverId) {
  db.ref('fuel_operations').orderByChild('userId').equalTo(driverId).once('value').then(snap => {
    if (!snap.exists()) {
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚');
      return;
    }
    
    let operationsHTML = `
      <div style="text-align:right;padding:20px;max-height:400px;overflow-y:auto;">
        <h3 style="margin-top:0;">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    `;
    
    let operations = [];
    snap.forEach(child => {
      operations.push(child.val());
    });
    
    operations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    operations.forEach(op => {
      const date = new Date(op.createdAt);
      const formattedDate = date.toLocaleString('ar-SA');
      
      operationsHTML += `
        <div style="background:#1e293b;padding:15px;border-radius:10px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:bold;color:${op.isSuspicious ? '#dc2626' : '#22c55e'}">
              ${op.status || 'Ø·Ø¨ÙŠØ¹ÙŠØ©'}
            </div>
            <div style="color:#94a3b8;font-size:12px;">${formattedDate}</div>
          </div>
          <div style="margin-top:10px;">
            <div>Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª: ${op.kmBefore?.toLocaleString() || '0'} â† ${op.kmAfter?.toLocaleString() || '0'}</div>
            <div>Ø§Ù„ÙØ±Ù‚: <span style="color:#f59e0b">${op.kmDifference?.toLocaleString() || '0'} ÙƒÙ…</span></div>
            ${op.suspicionReason ? `<div style="color:#dc2626;font-size:12px;">${op.suspicionReason}</div>` : ''}
          </div>
        </div>
      `;
    });
    
    operationsHTML += `</div>`;
    showCustomAlert(operationsHTML);
  });
}

function editDriver(driverId) {
  db.ref('users/' + driverId).once('value').then(snap => {
    const driver = snap.val();
    if (!driver) return;
    
    let editForm = `
      <div style="text-align:right;padding:20px;">
        <h3 style="margin-top:0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
        <div style="display:grid;gap:10px;">
          <div>
            <label style="display:block;margin-bottom:5px;color:#94a3b8;">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
            <input type="text" id="editDriverName" value="${driver.name || ''}" style="width:100%;padding:10px;border-radius:8px;background:#1e293b;border:1px solid #334155;color:white;">
          </div>
          <div>
            <label style="display:block;margin-bottom:5px;color:#94a3b8;">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
            <input type="text" id="editDriverProject" value="${driver.project || ''}" style="width:100%;padding:10px;border-radius:8px;background:#1e293b;border:1px solid #334155;color:white;">
          </div>
          <div>
            <label style="display:block;margin-bottom:5px;color:#94a3b8;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <input type="text" id="editDriverRegion" value="${driver.region || ''}" style="width:100%;padding:10px;border-radius:8px;background:#1e293b;border:1px solid #334155;color:white;">
          </div>
          <div>
            <label style="display:block;margin-bottom:5px;color:#94a3b8;">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
            <input type="text" id="editVehicleType" value="${driver.vehicleType || ''}" style="width:100%;padding:10px;border-radius:8px;background:#1e293b;border:1px solid #334155;color:white;">
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
          <button class="success-btn" style="flex:1;" onclick="saveDriverChanges('${driverId}')">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button class="secondary" style="flex:1;" onclick="closeCustomAlert()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    `;
    
    showCustomAlert(editForm);
  });
}

function saveDriverChanges(driverId) {
  const name = document.getElementById('editDriverName').value.trim();
  const project = document.getElementById('editDriverProject').value.trim();
  const region = document.getElementById('editDriverRegion').value.trim();
  const vehicleType = document.getElementById('editVehicleType').value.trim();
  
  if (!name || !project || !region) {
    return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
  }
  
  const updates = {
    name: name,
    project: project,
    region: region,
    vehicleType: vehicleType,
    updatedAt: new Date().toISOString(),
    updatedBy: auth.currentUser.email
  };
  
  db.ref('users/' + driverId).update(updates)
    .then(() => {
      alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­');
      closeCustomAlert();
    })
    .catch(error => {
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
    });
}

function toggleDriverStatus(driverId, currentStatus) {
  const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
  const actionText = newStatus === 'active' ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„';
  
  if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${actionText} Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚ØŸ`)) {
    db.ref('users/' + driverId).update({
      status: newStatus,
      statusUpdatedAt: new Date().toISOString(),
      statusUpdatedBy: auth.currentUser.email
    }).then(() => {
      alert(`âœ… ØªÙ… ${actionText} Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­`);
    }).catch(error => {
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚: ' + error.message);
    });
  }
}

function exportDriversData() {
  db.ref('users').orderByChild('role').equalTo('driver').once('value').then(snap => {
    if (!snap.exists()) {
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
      return;
    }
    
    let csv = 'Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚,Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ,Ø§Ù„Ù…Ø´Ø±ÙˆØ¹,Ø§Ù„Ù…Ù†Ø·Ù‚Ø©,Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„,Ø§Ù„Ø­Ø§Ù„Ø©,Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª\n';
    
    const drivers = [];
    snap.forEach(child => {
      drivers.push({ id: child.key, ...child.val() });
    });
    
    // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙƒÙ„ Ø³Ø§Ø¦Ù‚
    const driverPromises = drivers.map(driver => {
      return db.ref('fuel_operations').orderByChild('userId').equalTo(driver.id).once('value')
        .then(opSnap => {
          const operationsCount = opSnap.exists() ? opSnap.numChildren() : 0;
          return { ...driver, operationsCount };
        });
    });
    
    Promise.all(driverPromises).then(driversWithOps => {
      driversWithOps.forEach(driver => {
        const row = [
          `"${driver.name || ''}"`,
          `"${driver.email || ''}"`,
          `"${driver.project || ''}"`,
          `"${driver.region || ''}"`,
          `"${driver.vehicleType || ''}"`,
          `"${new Date(driver.createdAt).toLocaleDateString('ar-SA')}"`,
          `"${driver.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}"`,
          `"${driver.operationsCount}"`
        ].join(',');
        
        csv += row + '\n';
      });
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV ÙˆØªÙ†Ø²ÙŠÙ„Ù‡
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `Ø³Ø§Ø¦Ù‚ÙŠÙ†_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
    });
  });
}

/************** ANALYSIS FUNCTIONS **************/
function loadAnalysis() {
  // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  db.ref('fuel_operations').once('value').then(snap => {
    if (!snap.exists()) {
      document.getElementById('totalOperationsStats').textContent = '0';
      document.getElementById('suspiciousPercentage').textContent = '0%';
      document.getElementById('avgDifferenceStats').textContent = '0 ÙƒÙ…';
      document.getElementById('topProject').textContent = '-';
      return;
    }
    
    let total = 0;
    let suspicious = 0;
    let totalDiff = 0;
    const projects = {};
    const regions = {};
    
    snap.forEach(child => {
      const op = child.val();
      total++;
      
      if (op.isSuspicious) suspicious++;
      if (op.kmDifference) totalDiff += op.kmDifference;
      
      if (op.userProject) {
        projects[op.userProject] = (projects[op.userProject] || 0) + 1;
      }
      
      if (op.userRegion) {
        regions[op.userRegion] = (regions[op.userRegion] || 0) + 1;
      }
    });
    
    const suspiciousPercentage = total > 0 ? Math.round((suspicious / total) * 100) : 0;
    const avgDiff = total > 0 ? Math.round(totalDiff / total) : 0;
    
    let topProject = '-';
    let maxCount = 0;
    for (const [project, count] of Object.entries(projects)) {
      if (count > maxCount) {
        maxCount = count;
        topProject = project;
      }
    }
    
    document.getElementById('totalOperationsStats').textContent = total;
    document.getElementById('suspiciousPercentage').textContent = suspiciousPercentage + '%';
    document.getElementById('avgDifferenceStats').textContent = avgDiff + ' ÙƒÙ…';
    document.getElementById('topProject').textContent = topProject;
    
    // Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    drawRegionDistribution(regions);
    drawProjectDistribution(projects);
  });
}

function drawRegionDistribution(regions) {
  const container = document.getElementById('regionDistribution');
  container.innerHTML = '';
  
  if (Object.keys(regions).length === 0) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    return;
  }
  
  let total = Object.values(regions).reduce((a, b) => a + b, 0);
  let html = '<div style="height:100%;display:flex;flex-direction:column;gap:5px;">';
  
  Object.entries(regions).forEach(([region, count]) => {
    const percentage = Math.round((count / total) * 100);
    const barWidth = percentage + '%';
    
    html += `
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:100px;text-align:left;font-size:12px;">${region}</div>
        <div style="flex:1;background:#334155;border-radius:5px;overflow:hidden;">
          <div style="background:#3b82f6;height:20px;width:${barWidth};border-radius:5px;"></div>
        </div>
        <div style="width:50px;text-align:left;font-size:12px;color:#3b82f6;">${count} (${percentage}%)</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function drawProjectDistribution(projects) {
  const container = document.getElementById('projectDistribution');
  container.innerHTML = '';
  
  if (Object.keys(projects).length === 0) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    return;
  }
  
  const colors = ['#22c55e', '#f59e0b', '#3b82f6', '#dc2626', '#8b5cf6', '#ec4899', '#14b8a6'];
  let total = Object.values(projects).reduce((a, b) => a + b, 0);
  let html = '<div style="height:100%;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;">';
  
  Object.entries(projects).forEach(([project, count], index) => {
    const percentage = Math.round((count / total) * 100);
    const color = colors[index % colors.length];
    
    html += `
      <div style="text-align:center;">
        <div style="width:80px;height:80px;border-radius:50%;background:conic-gradient(${color} 0% ${percentage}%, #334155 ${percentage}% 100%);display:flex;align-items:center;justify-content:center;margin:0 auto 5px;">
          <div style="width:60px;height:60px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;">
            <span style="font-size:12px;color:white;">${percentage}%</span>
          </div>
        </div>
        <div style="font-size:12px;max-width:80px;word-wrap:break-word;">${project}</div>
        <div style="font-size:10px;color:#94a3b8;">${count} Ø¹Ù…Ù„ÙŠØ©</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

/************** HELPER FUNCTIONS **************/
function showCustomAlert(content) {
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø³Ø¨Ù‚
  const existingAlert = document.querySelector('.custom-alert');
  if (existingAlert) existingAlert.remove();
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
  const alertDiv = document.createElement('div');
  alertDiv.className = 'custom-alert';
  
  const alertContent = document.createElement('div');
  alertContent.className = 'custom-alert-content';
  alertContent.innerHTML = content;
  
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
  const closeBtn = document.createElement('button');
  closeBtn.className = 'close-alert';
  closeBtn.textContent = 'âœ•';
  closeBtn.onclick = closeCustomAlert;
  alertContent.appendChild(closeBtn);
  
  alertDiv.appendChild(alertContent);
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  document.body.appendChild(alertDiv);
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  alertDiv.onclick = (e) => {
    if (e.target === alertDiv) {
      closeCustomAlert();
    }
  };
}

function closeCustomAlert() {
  const alert = document.querySelector('.custom-alert');
  if (alert) alert.remove();
}

/************** INITIALIZE PAGE **************/
document.addEventListener('DOMContentLoaded', function() {
  // Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
  if (window.location.hash === '#camera') {
    startCamera();
  }
});
</script>
</body>
</html>
