<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fuel Proof â€“ Zahrani Logistics</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    * {box-sizing:border-box;font-family:'Cairo',system-ui;}
    body {margin:0;background:#0b1220;color:#e5e7eb;display:flex;flex-direction:column;min-height:100vh;}
    header {background:#020617;padding:18px 24px;display:flex;align-items:center;gap:16px;justify-content:flex-start;}
    header img {height:64px;max-width:220px;object-fit:contain;}
    header h1 {font-size:18px;margin:0;flex-grow:1;}
    .header-buttons {display:flex;gap:10px;}

    main {padding:20px;max-width:1200px;margin:auto;flex:1;width:100%;}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;}
    .card {background:#020617;border-radius:18px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,.35);transition:transform .2s;}
    .card:hover {transform:translateY(-5px);}
    .card h3 {text-align:center;margin-top:0;font-size:18px;}

    input, button {border-radius:14px;padding:12px;border:none;font-size:14px;}
    input {width:100%;background:#020617;color:#e5e7eb;border:1px solid #334155;}
    input:focus {outline:none;border-color:#22c55e;}
    button {background:#22c55e;font-weight:800;cursor:pointer;color:#fff;transition:background .2s;}
    button:hover {background:#16a34a;}
    button.secondary {background:#334155;color:#e5e7eb;}
    button.logout-btn {background:#dc2626;}
    button.login-btn {background:#3b82f6;}

    video, canvas, img {width:100%;border-radius:14px;}
    .row {display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
    .hidden {display:none;}

    footer {text-align:center;opacity:.6;font-size:12px;margin:30px 0;}

    /* AUTH PAGES */
    .auth-page {display:flex;align-items:center;justify-content:center;min-height:80vh;width:100%;}
    .auth-container {max-width:400px;width:100%;}
    .auth-tabs {display:flex;margin-bottom:20px;border-bottom:2px solid #334155;}
    .auth-tab {flex:1;text-align:center;padding:12px;cursor:pointer;background:none;border:none;color:#94a3b8;font-weight:600;}
    .auth-tab.active {color:#22c55e;border-bottom:3px solid #22c55e;}
    .user-info {display:flex;align-items:center;gap:10px;color:#e5e7eb;font-size:14px;}
  </style>
</head>
<body>

<header>
  <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Fuel Proof">
  <h1>Fuel Proof System</h1>
  <div class="header-buttons" id="headerButtons">
    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
  </div>
</header>

<!-- AUTHENTICATION PAGE (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
<main id="authPage" class="auth-page">
  <div class="auth-container">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <!-- LOGIN FORM -->
    <div class="card" id="loginForm">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
      <br><br>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <br><br>
      <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>
    
    <!-- REGISTER FORM -->
    <div class="card hidden" id="registerForm">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</h3>
      <input id="newEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
      <br><br>
      <input id="newPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <br><br>
      <button onclick="registerDriver()">ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>
  </div>
</main>

<!-- MAIN APP (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
<main id="app" class="hidden">
  <div class="grid">

    <!-- DRIVER -->
    <div class="card" id="driverBox">
      <h3>ğŸ“· Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h3>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" hidden></canvas>
      <img id="preview" />
      <div class="row">
        <button onclick="capture()">Ø§Ù„ØªÙ‚Ø§Ø·</button>
        <button class="secondary" onclick="sendOperation()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <!-- ADMIN -->
    <div class="card hidden" id="adminBox">
      <h3>ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <table style="width:100%;font-size:13px">
        <thead><tr><th>ØµÙˆØ±Ø©</th><th>ÙˆÙ‚Øª</th><th>OCR</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th></tr></thead>
        <tbody id="ops"></tbody>
      </table>
    </div>

  </div>

  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ 2025
  </footer>
</main>

<script>
/************** FIREBASE CONFIG **************/
const firebaseConfig = {
  apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
  authDomain: "tama-6219c.firebaseapp.com",
  databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
  projectId: "tama-6219c",
  appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/************** AUTH TABS **************/
function switchAuthTab(tab) {
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'login') {
    document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
  } else {
    document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
  }
}

/************** UPDATE HEADER **************/
function updateHeader(user, role) {
  const headerButtons = document.getElementById('headerButtons');
  headerButtons.innerHTML = '';
  
  if (!user) {
    // ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ù„Ø§ ØªØ¸Ù‡Ø± Ø£ÙŠ Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    // (Ù„Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù‡ÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©)
  } else {
    // Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    const userInfo = document.createElement('div');
    userInfo.className = 'user-info';
    
    const userName = user.email ? user.email.split('@')[0] : 'Ù…Ø³ØªØ®Ø¯Ù…';
    const userRole = role === 'admin' ? ' (Ø£Ø¯Ù…Ù†)' : ' (Ø³Ø§Ø¦Ù‚)';
    
    userInfo.innerHTML = `
      <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}${userRole}</span>
    `;
    
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
    logoutBtn.className = 'logout-btn';
    logoutBtn.onclick = () => {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        auth.signOut();
      }
    };
    
    headerButtons.appendChild(userInfo);
    headerButtons.appendChild(logoutBtn);
  }
}

/************** PAGE NAVIGATION **************/
function showAuthPage() {
  document.getElementById('authPage').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  switchAuthTab('login'); // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
}

function showAppPage() {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
}

/************** LOGIN **************/
function login() {
  const userEmail = document.getElementById('email').value.trim();
  const userPassword = document.getElementById('password').value.trim();

  if (!userEmail || !userPassword) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  auth.signInWithEmailAndPassword(userEmail, userPassword)
    .then(() => {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    })
    .catch(e => alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + e.message));
}

/************** REGISTER DRIVER **************/
function registerDriver() {
  const newEmail = document.getElementById('newEmail').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();

  if (!newEmail || !newPassword) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  if (newPassword.length < 6) {
    return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  }

  auth.createUserWithEmailAndPassword(newEmail, newPassword)
    .then(cred => {
      return db.ref('users/' + cred.user.uid).set({ 
        role: 'driver', 
        name: newEmail.split('@')[0],
        email: newEmail,
        createdAt: new Date().toISOString()
      });
    })
    .then(() => {
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      switchAuthTab('login');
      document.getElementById('newEmail').value = '';
      document.getElementById('newPassword').value = '';
    })
    .catch(err => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + err.message));
}

/************** AUTH STATE **************/
auth.onAuthStateChanged(async user => {
  if (!user) {
    // ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
    updateHeader(null, null);
    showAuthPage();
    return;
  }
  
  // Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
  const snap = await db.ref('users/' + user.uid).get();
  const userData = snap.val();
  const role = userData?.role || 'driver';
  
  updateHeader(user, role);
  showAppPage();

  if (role === 'admin') {
    document.getElementById('adminBox').classList.remove('hidden');
    document.getElementById('driverBox').classList.add('hidden');
    loadAdmin();
  } else {
    document.getElementById('driverBox').classList.remove('hidden');
    document.getElementById('adminBox').classList.add('hidden');
    startCamera();
  }
});

/************** CAMERA **************/
let stream;
function startCamera() {
  if (document.getElementById('driverBox').classList.contains('hidden')) return;
  
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(s => {
      stream = s; 
      document.getElementById('video').srcObject = s;
    })
    .catch(err => {
      console.log('Camera error:', err);
      alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
    });
}

function capture() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  
  if (!video.videoWidth) {
    return alert('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹');
  }
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  preview.src = canvas.toDataURL('image/jpeg', 0.9);
}

/************** SEND OPERATION **************/
async function sendOperation() {
  const preview = document.getElementById('preview');
  if (!preview.src || preview.src.startsWith('data:') === false) {
    return alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
  }

  const user = auth.currentUser;
  if (!user) {
    alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  const userName = (await db.ref('users/' + user.uid).get()).val()?.name || 'Ù…Ø¬Ù‡ÙˆÙ„';

  let ocrText = '';
  try {
    const ocr = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=AIzaSyC0JhoFGiCh102Q9X0y0xaWgFG-NQINWUk", {
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: 'Ø§Ù‚Ø±Ø£ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©' }, 
            { inline_data: { mime_type: 'image/jpeg', data: preview.src.split(',')[1] } }
          ]
        }]
      })
    }).then(r => r.json());

    ocrText = ocr.candidates?.[0]?.content?.parts?.[0]?.text || 'Ù„Ù… ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ';
  } catch (error) {
    console.error('OCR Error:', error);
    ocrText = 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©';
  }

  db.ref('fuel_operations').push({
    image: preview.src,
    ocr: ocrText,
    created: new Date().toISOString(),
    userId: user.uid,
    userName: userName,
    userEmail: user.email
  });

  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
  preview.src = '';
}

/************** ADMIN **************/
function loadAdmin() {
  db.ref('fuel_operations').orderByChild('created').limitToLast(50).on('value', snap => {
    const opsElement = document.getElementById('ops');
    opsElement.innerHTML = '';
    
    if (!snap.exists()) {
      opsElement.innerHTML = '<tr><td colspan="4" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
      return;
    }
    
    const operations = [];
    snap.forEach(child => {
      operations.push({ id: child.key, ...child.val() });
    });
    
    operations.reverse();
    
    operations.forEach(op => {
      const date = new Date(op.created);
      const formattedDate = date.toLocaleString('ar-SA');
      
      opsElement.innerHTML += `
        <tr>
          <td><img src="${op.image}" height="50" style="border-radius:8px;cursor:pointer" onclick="window.open('${op.image}')"></td>
          <td>${formattedDate}</td>
          <td style="max-width:200px;word-break:break-all">${op.ocr || ''}</td>
          <td>${op.userName || op.userEmail || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td>
        </tr>
      `;
    });
  });
}

/************** INITIALIZE **************/
document.addEventListener('DOMContentLoaded', function() {
  // Ø§Ù„ØµÙØ­Ø© Ø³ØªØ¸Ù‡Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
});
</script>

</body>
</html>
