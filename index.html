<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fuel System Ultra | Al Zahrani</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
:root {
  --p:#3b82f6; --s:#22c55e; --d:#ef4444;
  --bg:#0f172a; --c:#1e293b; --t:#f8fafc;
}
*{box-sizing:border-box;font-family:Tahoma,Arial;}
body{margin:0;background:var(--bg);color:var(--t)}
.card{background:var(--c);padding:15px;border-radius:12px;margin:10px;border:1px solid #334155}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #444;background:#0f172a;color:#fff}
button{cursor:pointer}
.btn-success{background:var(--s);border:none;font-weight:bold}
.hidden{display:none}
table{width:100%;border-collapse:collapse;min-width:900px;font-size:13px}
th,td{border:1px solid #334155;padding:8px;text-align:center}
.thumb{width:50px;height:50px;object-fit:cover;border-radius:4px}
#statusOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;z-index:9999
}
</style>
</head>

<body>

<div id="statusOverlay">
  <div style="text-align:center">
    <div style="font-size:40px">â³</div>
    <h3 id="statusTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</h3>
    <button id="okBtn" class="hidden" onclick="location.reload()" style="background:var(--p);width:150px">Ù…ÙˆØ§ÙÙ‚</button>
  </div>
</div>

<!-- AUTH -->
<section id="sec_auth" class="hidden">
<div class="card" style="max-width:400px;margin:50px auto">
<h3 style="text-align:center">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
<input id="uInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="pInp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button style="background:var(--p)" onclick="login()">Ø¯Ø®ÙˆÙ„</button>

<button style="background:none;border:none;color:var(--p)" onclick="toggleReg()">+ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚</button>

<div id="regBox" class="hidden">
<input id="r_n" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">
<input id="r_pl" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">
<input id="r_pj" placeholder="Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
<input id="r_u" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="r_p" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button style="background:var(--s)" onclick="register()">ØªØ£ÙƒÙŠØ¯</button>
</div>
</div>
</section>

<!-- DRIVER -->
<section id="sec_driver" class="hidden">
<div class="card" style="text-align:center">
<h3 id="driverName"></h3>
<video id="cam" autoplay playsinline style="width:100%;max-width:400px;border-radius:10px;background:#000"></video>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:10px">
<button onclick="capture('p')">ğŸ“¸ Ø§Ù„Ù„ÙˆØ­Ø©</button>
<button onclick="capture('b')">ğŸ“¸ Ù‚Ø¨Ù„</button>
<button onclick="capture('a')">ğŸ“¸ Ø¨Ø¹Ø¯</button>
<button id="videoBtn" style="background:var(--d)" onclick="recordVideo()">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ 5 Ø«ÙˆØ§Ù†ÙŠ</button>
</div>

<button id="sendBtn" class="btn-success" disabled onclick="sendReport()" style="margin-top:15px">
Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
</button>
</div>
</section>

<!-- ADMIN -->
<section id="sec_admin" class="hidden">
<div class="card">
<input id="fPlate" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù„ÙˆØ­Ø©" oninput="applyFilter()">
<input id="fFrom" type="date" onchange="applyFilter()">
<input id="fTo" type="date" onchange="applyFilter()">
<button style="background:#4f46e5" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div class="card" style="overflow-x:auto">
<table id="adminTable">
<thead>
<tr>
<th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
<th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØµÙˆØ±</th><th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</section>

<script>
// ================== Firebase ==================
firebase.initializeApp({
 apiKey:"AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
 authDomain:"tama-6219c.firebaseapp.com",
 databaseURL:"https://tama-6219c-default-rtdb.firebaseio.com",
 projectId:"tama-6219c"
});
const auth=firebase.auth(), db=firebase.database();

// ================== State ==================
let user=null, stream=null, recorder=null, chunks=[];
let media={p:null,b:null,a:null,v:null};
let reports=[];

// ================== Auth ==================
auth.onAuthStateChanged(async u=>{
 if(!u) return show('sec_auth');
 const snap=await db.ref('users/'+u.uid).get();
 const d=snap.val();
 if(!d) return auth.signOut();

 user=d;
 if(d.role==='admin'){ show('sec_admin'); loadReports(); }
 else{ show('sec_driver'); driverName.textContent=d.name; initCam(); }
});

function login(){
 const u=uInp.value.trim();
 auth.signInWithEmailAndPassword(u+'@z.com',pInp.value).catch(()=>alert('Ø®Ø·Ø£ Ø¯Ø®ÙˆÙ„'));
}

function toggleReg(){ regBox.classList.toggle('hidden'); }

function register(){
 auth.createUserWithEmailAndPassword(r_u.value+'@z.com',r_p.value)
 .then(r=>db.ref('users/'+r.user.uid).set({
   name:r_n.value, plate:r_pl.value, project:r_pj.value, role:'driver'
 }))
 .then(()=>location.reload())
 .catch(e=>alert(e.message));
}

// ================== Camera ==================
async function initCam(){
 try{
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:true});
  cam.srcObject=stream;
 }catch{ alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
}

function capture(t){
 const c=document.createElement('canvas');
 c.width=400; c.height=300;
 c.getContext('2d').drawImage(cam,0,0,400,300);
 media[t]=c.toDataURL('image/jpeg',0.5);
 checkReady();
 alert('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©');
}

function recordVideo(){
 if(recorder && recorder.state==='recording') return;
 chunks=[];
 recorder=new MediaRecorder(stream,{mimeType:'video/webm'});
 recorder.ondataavailable=e=>chunks.push(e.data);
 recorder.onstop=()=>{
  const r=new FileReader();
  r.onload=()=>{ media.v=r.result; checkReady(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'); };
  r.readAsDataURL(new Blob(chunks));
 };
 recorder.start();
 videoBtn.textContent='ğŸ”´ ØªØ³Ø¬ÙŠÙ„...';
 setTimeout(()=>{ recorder.stop(); videoBtn.textContent='ğŸ¥ ÙÙŠØ¯ÙŠÙˆ 5 Ø«ÙˆØ§Ù†ÙŠ'; },5000);
}

function checkReady(){
 sendBtn.disabled=!(media.p&&media.b&&media.a&&media.v);
}

// ================== Upload ==================
function sendReport(){
 statusOverlay.style.display='flex';
 navigator.geolocation.getCurrentPosition(pos=>{
  db.ref('reports').push({
   ...media,
   name:user.name, plate:user.plate, project:user.project,
   ts:Date.now(), lat:pos.coords.latitude, lng:pos.coords.longitude
  }).then(()=>{
   statusTxt.textContent='ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­';
   okBtn.classList.remove('hidden');
  }).catch(()=>{
   alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ (Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±)');
   statusOverlay.style.display='none';
  });
 },()=>alert('ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ GPS'));
}

// ================== Admin ==================
function loadReports(){
 db.ref('reports').on('value',s=>{
  reports=[];
  s.forEach(c=>reports.push(c.val()));
  applyFilter();
 });
}

function applyFilter(){
 const p=fPlate.value.toLowerCase();
 const f=fFrom.value, t=fTo.value;
 const res=reports.filter(r=>{
  const d=new Date(r.ts).toISOString().split('T')[0];
  return r.plate.toLowerCase().includes(p) &&
         (!f||d>=f)&&(!t||d<=t);
 });
 render(res);
}

function render(data){
 tbody.innerHTML=data.reverse().map(r=>`
<tr>
<td>${r.name}</td><td>${r.plate}</td><td>${r.project}</td>
<td>${new Date(r.ts).toLocaleString('ar-SA')}</td>
<td>
<img src="${r.p}" class="thumb">
<img src="${r.b}" class="thumb">
<img src="${r.a}" class="thumb">
</td>
<td><a href="${r.v}" download>ØªØ­Ù…ÙŠÙ„</a></td>
<td><a target="_blank" href="https://maps.google.com/?q=${r.lat},${r.lng}">ğŸ“</a></td>
</tr>`).join('');
}

function exportExcel(){
 XLSX.writeFile(XLSX.utils.table_to_book(adminTable),'Reports.xlsx');
}

// ================== UI ==================
function show(id){
 document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
}
</script>
</body>
</html>
