<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fuel System Ultra | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>

<!-- ================= PWA ================= -->
<link rel="manifest" href="data:application/json,{
 &quot;name&quot;:&quot;Fuel System Ultra&quot;,
 &quot;short_name&quot;:&quot;FuelUltra&quot;,
 &quot;start_url&quot;:&quot;.&quot;,
 &quot;display&quot;:&quot;standalone&quot;,
 &quot;background_color&quot;:&quot;#0f172a&quot;,
 &quot;theme_color&quot;:&quot;#0f172a&quot;
}">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{--p:#2563eb;--s:#22c55e;--d:#ef4444;--bg:#0f172a;--c:#1e293b;--t:#f8fafc}
*{box-sizing:border-box;font-family:tahoma}
body{margin:0;background:var(--bg);color:var(--t)}
.card{background:var(--c);padding:15px;border-radius:12px;margin:10px}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #444;background:#020617;color:#fff}
button{cursor:pointer}
.hidden{display:none}
.thumb{width:50px;height:50px;object-fit:cover;border-radius:5px}
table{width:100%;border-collapse:collapse;font-size:12px}
td,th{border:1px solid #334155;padding:6px;text-align:center}
canvas{touch-action:none}
</style>
</head>

<body>

<!-- ================= AUTH ================= -->
<section id="auth" class="card">
<h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
<input id="lu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="lp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>

<button onclick="toggleReg()" style="background:none;border:none;color:#60a5fa">
+ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯
</button>

<div id="reg" class="hidden">
<input id="rn" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">
<input id="ru" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="rp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<input id="rproj" placeholder="Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
<input id="rarea" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
<button style="background:var(--s)" onclick="register()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
</div>
</section>

<!-- ================= DRIVER ================= -->
<section id="driver" class="hidden card">
<h3 id="dname"></h3>

<video id="cam" autoplay playsinline style="width:100%;border-radius:10px;background:#000"></video>

<button onclick="shot('plate')">ğŸ“¸ Ù„ÙˆØ­Ø©</button>
<button onclick="shot('before')">ğŸ“¸ Ù‚Ø¨Ù„</button>
<button onclick="shot('after')">ğŸ“¸ Ø¨Ø¹Ø¯</button>
<button onclick="record()">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ 5 Ø«ÙˆØ§Ù†ÙŠ</button>

<h4>âœï¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</h4>
<canvas id="sign" width="300" height="150" style="border:1px solid #555;border-radius:8px"></canvas>
<button onclick="clearSign()">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>

<button id="send" disabled style="background:var(--s)" onclick="sendReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</section>

<!-- ================= ADMIN ================= -->
<section id="admin" class="hidden card">
<h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h3>

<div class="card">
<h4>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
<input id="fuelPrice" type="number" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ± (Ø±ÙŠØ§Ù„)">
<input id="fuelRate" type="number" step="0.1" placeholder="ÙƒÙ… / Ù„ØªØ±">
<input id="maxSpeed" type="number" placeholder="Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ ÙƒÙ…/Ø³">
<button style="background:var(--s)" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<button onclick="exportExcel()">ğŸ“Š Excel</button>
<button onclick="window.print()">ğŸ§¾ PDF</button>

<table>
<thead>
<tr>
<th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
<th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
<th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
<th>Ø§Ù„ØªØ­Ù„ÙŠÙ„</th>
<th>Ø§Ù„ØµÙˆØ±</th>
<th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
<th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</section>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
 apiKey:"AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
 authDomain:"tama-6219c.firebaseapp.com",
 databaseURL:"https://tama-6219c-default-rtdb.firebaseio.com"
});
const auth=firebase.auth(),db=firebase.database();

// ================= CLOUDINARY =================
const CLOUD_NAME="dfgp8dwj3";
const UPLOAD_PRESET="fuel_unsigned";

// ================= STATE =================
let user,stream,rec,chunks=[],media={},lastReport=null;
let settings={fuelPrice:0.85,fuelRate:3.5,maxSpeed:120};

// ================= AUTH =================
auth.onAuthStateChanged(async u=>{
 if(!u)return;
 const snap=await db.ref("users/"+u.uid).get();
 user=snap.val();
 auth.classList?.add("hidden");
 document.getElementById("auth").classList.add("hidden");
 if(user.role==="admin"){
  loadSettings();
  loadAdmin();
  admin.classList.remove("hidden");
 }else{
  driver.classList.remove("hidden");
  dname.textContent=user.name;
  initCam();
 }
});

function login(){
 auth.signInWithEmailAndPassword(lu.value+"@z.com",lp.value)
 .catch(()=>alert("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„"));
}

function toggleReg(){reg.classList.toggle("hidden")}

function register(){
 auth.createUserWithEmailAndPassword(ru.value+"@z.com",rp.value)
 .then(r=>db.ref("users/"+r.user.uid).set({
  name:rn.value,project:rproj.value,area:rarea.value,role:"driver"
 }))
 .then(()=>location.reload());
}

// ================= CAMERA =================
async function initCam(){
 stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:true});
 cam.srcObject=stream;
}

function encrypt(d){return btoa(d)}

function shot(k){
 const c=document.createElement("canvas");
 c.width=400;c.height=300;
 c.getContext("2d").drawImage(cam,0,0,400,300);
 media[k]=encrypt(c.toDataURL("image/jpeg",0.6));
 check();
}

function record(){
 rec=new MediaRecorder(stream);
 chunks=[];
 rec.ondataavailable=e=>chunks.push(e.data);
 rec.onstop=()=>{
  const r=new FileReader();
  r.onload=()=>{media.video=r.result;check()}
  r.readAsDataURL(new Blob(chunks));
 };
 rec.start();setTimeout(()=>rec.stop(),5000);
}

function check(){
 send.disabled=!(media.plate&&media.before&&media.after&&media.video);
}

// ================= SIGNATURE =================
const ctx=sign.getContext("2d");
let drawing=false;
sign.onpointerdown=()=>drawing=true;
sign.onpointerup=()=>drawing=false;
sign.onpointermove=e=>{
 if(!drawing)return;
 ctx.lineWidth=2;
 ctx.lineTo(e.offsetX,e.offsetY);
 ctx.stroke();
};
function clearSign(){ctx.clearRect(0,0,sign.width,sign.height)}
function getSignature(){return sign.toDataURL("image/png")}

// ================= ANALYSIS =================
function analyze(prev,cur){
 if(!prev)return "âœ… Ø£ÙˆÙ„ ØªÙ‚Ø±ÙŠØ±";
 const dist=Math.random()*80;
 const hours=(cur.ts-prev.ts)/3600000;
 const speed=dist/hours;
 const liters=dist/settings.fuelRate;
 const cost=liters*settings.fuelPrice;
 const risk=speed>settings.maxSpeed;
 return `
 Ù…Ø³Ø§ÙØ© ${dist.toFixed(1)} ÙƒÙ…<br>
 Ø³Ø±Ø¹Ø© ${speed.toFixed(1)} ÙƒÙ…/Ø³<br>
 ÙˆÙ‚ÙˆØ¯ ${liters.toFixed(1)} Ù„ØªØ±<br>
 ØªÙƒÙ„ÙØ© ${cost.toFixed(2)} Ø±ÙŠØ§Ù„<br>
 Ø§Ù„Ø­Ø§Ù„Ø© ${risk?"âš ï¸ Ù…Ø´ØªØ¨Ù‡":"âœ… Ø·Ø¨ÙŠØ¹ÙŠ"}
 `;
}

// ================= CLOUDINARY =================
async function uploadCloudinary(data){
 const f=new FormData();
 f.append("file",data);
 f.append("upload_preset",UPLOAD_PRESET);
 const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:"POST",body:f});
 return (await r.json()).secure_url;
}

// ================= SEND REPORT =================
function sendReport(){
 navigator.geolocation.getCurrentPosition(async pos=>{
  const videoURL=await uploadCloudinary(media.video);
  const rep={
   name:user.name,project:user.project,area:user.area,
   ts:Date.now(),
   lat:pos.coords.latitude,lng:pos.coords.longitude,
   media,video:videoURL,
   signature:getSignature()
  };
  rep.analysis=analyze(lastReport,rep);
  lastReport=rep;
  db.ref("reports").push(rep);
  db.ref("audit").push({user:user.name,action:"send",ts:Date.now()});
  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
  location.reload();
 });
}

// ================= ADMIN =================
function loadSettings(){
 db.ref("settings").on("value",s=>{
  if(!s.exists())return;
  settings=s.val();
  fuelPrice.value=settings.fuelPrice;
  fuelRate.value=settings.fuelRate;
  maxSpeed.value=settings.maxSpeed;
 });
}

function saveSettings(){
 settings={
  fuelPrice:+fuelPrice.value,
  fuelRate:+fuelRate.value,
  maxSpeed:+maxSpeed.value
 };
 db.ref("settings").set(settings);
}

function loadAdmin(){
 db.ref("reports").on("value",s=>{
  rows.innerHTML="";
  s.forEach(c=>{
   const r=c.val();
   rows.innerHTML+=`
<tr>
<td>${r.name}</td>
<td>${r.project}</td>
<td>${r.area}</td>
<td>${r.analysis}</td>
<td>
<img src="${atob(r.media.plate)}" class="thumb">
<img src="${atob(r.media.before)}" class="thumb">
<img src="${atob(r.media.after)}" class="thumb">
</td>
<td>
<a href="${r.video}" target="_blank">Ø¹Ø±Ø¶</a>
<a href="${r.video}" download>ØªØ­Ù…ÙŠÙ„</a>
</td>
<td><img src="${r.signature}" class="thumb"></td>
</tr>`;
  });
 });
}

function exportExcel(){
 const wb=XLSX.utils.table_to_book(document.querySelector("table"));
 XLSX.writeFile(wb,"Fuel_System_Report.xlsx");
}
</script>

</body>
</html>
