<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Proof | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.ibb.co/yFCW2v98/Untitled.webp">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #ef4444; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--t); overflow-x: hidden; }
        
        header { background: var(--c); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--p); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-area img { height: 45px; border-radius: 8px; border: 1px solid var(--p); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .card { background: var(--c); padding: 25px; border-radius: 20px; border: 1px solid #334155; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 25px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--p); box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; font-size: 16px; transition: 0.3s; margin-bottom: 10px; }
        .btn-main { background: var(--p); color: white; }
        .btn-main:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-sec { background: transparent; border: 2px solid var(--p); color: var(--p); }
        .btn-success { background: var(--s); color: white; }

        .captcha-wrapper { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px dashed var(--p); text-align: center; margin-bottom: 15px; }
        #captchaDisplay { font-size: 32px; font-weight: 900; color: var(--s); letter-spacing: 15px; user-select: none; font-style: italic; text-shadow: 2px 2px #000; }
        
        .hidden { display: none !important; }
        .error-msg { color: var(--d); text-align: center; font-weight: bold; font-size: 14px; margin-top: 10px; }
        
        /* Dashboard Styles */
        .table-res { overflow-x: auto; border-radius: 15px; background: #1e293b; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #0f172a; padding: 15px; color: var(--p); border-bottom: 2px solid #334155; text-align: center; }
        td { padding: 15px; border-bottom: 1px solid #334155; text-align: center; font-size: 14px; }
        .img-thumb { width: 45px; height: 45px; border-radius: 5px; object-fit: cover; border: 1px solid var(--p); margin: 0 2px; }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <div>
            <div style="font-weight:900; color:var(--p); font-size: 18px;">FUEL PROOF</div>
            <div style="font-size:10px; color:#94a3b8;">Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</div>
        </div>
    </div>
    <div id="statusLabel" style="font-size:12px; font-weight:bold;"></div>
</header>

<div class="container">
    <section id="authPage">
        <div class="card" style="max-width:450px; margin: 40px auto;">
            <h2 id="authTitle" style="text-align:center; color:var(--p); margin-bottom:25px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            
            <div id="loginFields">
                <input type="text" id="emailInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯">
                <input type="password" id="passInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                
                <div class="captcha-wrapper">
                    <div id="captchaDisplay"></div>
                    <p style="font-size:10px; color:#94a3b8; margin:5px 0 0 0;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚</p>
                </div>
                <input type="text" id="capVerify" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚">
                
                <button class="btn-main" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                <button class="btn-sec" onclick="toggleAuth(true)">Ø³Ø¬Ù„ ÙƒÙ€Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="regFields" class="hidden">
                <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="regProj" placeholder="Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                <input type="text" id="regUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨">
                <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-success" onclick="handleRegister()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn-sec" onclick="toggleAuth(false)">Ø±Ø¬ÙˆØ¹</button>
            </div>
            
            <div id="errMsg" class="error-msg"></div>
        </div>
    </section>

    <section id="adminSec" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                <button onclick="location.reload()" style="width:auto; padding:8px 20px; font-size:12px;" class="btn-sec">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            <div class="table-res">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</th><th>Ø§Ù„ØµÙˆØ± (Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯)</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th></tr>
                    </thead>
                    <tbody id="logsTable"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="driverSec" class="hidden">
        <div class="card">
            <h3 style="text-align:center; color:var(--p);">ğŸ“¸ ØªÙˆØ«ÙŠÙ‚ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚ÙˆØ¯</h3>
            <video id="cam" autoplay playsinline style="width:100%; border-radius:15px; border:3px solid var(--p);"></video>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <div onclick="takePhoto('b')"><img id="previewB" src="" style="width:100%; height:120px; background:#000; border-radius:10px; object-fit:cover;"><button class="btn-main" style="font-size:11px; margin-top:5px;">ØµÙˆØ±Ø© Ù‚Ø¨Ù„</button></div>
                <div onclick="takePhoto('a')"><img id="previewA" src="" style="width:100%; height:120px; background:#000; border-radius:10px; object-fit:cover;"><button class="btn-main" style="font-size:11px; margin-top:5px;">ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</button></div>
            </div>
            <button class="btn-success" style="margin-top:20px; font-size:18px;" onclick="uploadReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </section>
</div>

<script>
// Firebase Configuration
const fbConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(fbConfig);
const fAuth = firebase.auth();
const fDb = firebase.database();

let activeCaptcha = "";
function generateCaptcha() {
    activeCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('captchaDisplay').innerText = activeCaptcha;
}
generateCaptcha();

function toggleAuth(isReg) {
    document.getElementById('loginFields').classList.toggle('hidden', isReg);
    document.getElementById('regFields').classList.toggle('hidden', !isReg);
    document.getElementById('authTitle').innerText = isReg ? "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØµØ­Ø­Ø©
async function handleLogin() {
    const user = document.getElementById('emailInp').value.trim();
    const pass = document.getElementById('passInp').value; // Ø¨Ø¯ÙˆÙ† trim Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…ÙˆØ²
    const cap = document.getElementById('capVerify').value.trim();
    const err = document.getElementById('errMsg');

    if(cap !== activeCaptcha) {
        err.innerText = "âŒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­!";
        generateCaptcha();
        return;
    }

    const email = user.includes('@') ? user : `${user}@fuel.com`;

    try {
        const result = await fAuth.signInWithEmailAndPassword(email, pass);
        // Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±
        if(user === "honda@gmail.com") {
            await fDb.ref('users/' + result.user.uid).update({ role: 'admin', name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' });
        }
        location.reload();
    } catch (e) {
        err.innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„";
        console.error(e);
    }
}

async function handleRegister() {
    const u = document.getElementById('regUser').value.trim();
    const p = document.getElementById('regPass').value;
    const n = document.getElementById('regName').value.trim();
    const pr = document.getElementById('regProj').value.trim();

    try {
        const res = await fAuth.createUserWithEmailAndPassword(`${u}@fuel.com`, p);
        await fDb.ref('users/' + res.user.uid).set({ name: n, project: pr, role: 'driver' });
        location.reload();
    } catch(e) { alert(e.message); }
}

fAuth.onAuthStateChanged(user => {
    if(user) {
        fDb.ref('users/' + user.uid).once('value', snap => {
            const data = snap.val();
            if(!data) return;
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('statusLabel').innerHTML = `<span style="color:var(--s)">â— Ù…ØªØµÙ„: ${data.name}</span> | <a href="#" onclick="fAuth.signOut();location.reload()" style="color:var(--d)">Ø®Ø±ÙˆØ¬</a>`;
            
            if(data.role === 'admin') {
                document.getElementById('adminSec').classList.remove('hidden');
                loadAdminReports();
            } else {
                document.getElementById('driverSec').classList.remove('hidden');
                startCamera();
            }
        });
    }
});

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('cam').srcObject = stream;
}

let photoB = null, photoA = null;
function takePhoto(type) {
    const v = document.getElementById('cam');
    const c = document.createElement('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.6);
    if(type === 'b') { photoB = data; document.getElementById('previewB').src = data; }
    else { photoA = data; document.getElementById('previewA').src = data; }
}

function uploadReport() {
    if(!photoB || !photoA) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹!");
    navigator.geolocation.getCurrentPosition(pos => {
        const report = {
            driver: fAuth.currentUser.email.split('@')[0],
            imgB: photoB, imgA: photoA,
            lat: pos.coords.latitude, lng: pos.coords.longitude,
            timestamp: new Date().toLocaleString('ar-SA')
        };
        fDb.ref('reports').push(report).then(() => {
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!");
            location.reload();
        });
    }, () => alert("ÙØ¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ!"), {enableHighAccuracy: true});
}

function loadAdminReports() {
    fDb.ref('reports').on('value', snap => {
        let html = '';
        snap.forEach(child => {
            const v = child.val();
            html += `<tr>
                <td><b>${v.driver}</b></td>
                <td><a href="https://www.google.com/maps?q=${v.lat},${v.lng}" target="_blank" style="color:var(--s);text-decoration:none;">ğŸ“ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
                <td><img src="${v.imgB}" class="img-thumb"> <img src="${v.imgA}" class="img-thumb"></td>
                <td><span style="background:#0f172a; padding:5px 10px; border-radius:5px;">${v.timestamp}</span></td>
            </tr>`;
        });
        document.getElementById('logsTable').innerHTML = html || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
    });
}
</script>
</body>
</html>
