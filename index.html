<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Proof | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --success: #22c55e;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--bg-dark); color: var(--text-main); line-height: 1.6; overflow-x: hidden; }

        /* Layout */
        header { 
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
        }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo-section img { height: 45px; border-radius: 8px; }
        
        main { padding: 15px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; border: 1px solid var(--border); }

        /* UI Elements */
        input, select, button { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #0f172a; color: white; font-size: 15px; margin-bottom: 12px; outline: none; transition: 0.3s; }
        button { cursor: pointer; font-weight: 700; border: none; background: var(--primary); }
        button:active { transform: scale(0.98); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .hidden { display: none !important; }

        /* Camera & Photos */
        #video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; margin-bottom: 15px; border: 2px solid var(--primary); }
        video { width: 100%; display: block; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .photo-box { text-align: center; }
        .photo-box img { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; background: #000; border: 1px dashed var(--text-muted); }
        .photo-box p { font-size: 12px; margin: 5px 0; color: var(--text-muted); }

        /* Dashboard & Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-item { background: #0f172a; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 3px solid var(--primary); }
        .stat-val { display: block; font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

        /* Tables */
        .table-wrapper { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: #161e2e; font-size: 13px; }
        th { background: #0f172a; color: var(--text-muted); padding: 12px; text-align: right; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-warn { background: rgba(220, 38, 38, 0.2); color: #ef4444; }
        .badge-ok { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        /* Custom Alert Modal */
        .custom-alert { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .custom-alert-content { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; padding-top: 40px; }
        .close-alert { position: absolute; top: 10px; left: 15px; background: none; border: none; color: white; font-size: 24px; width: auto; }

        /* Analysis Charts */
        .chart-bar-bg { background: #334155; height: 12px; border-radius: 10px; overflow: hidden; flex: 1; }
        .chart-bar-fill { background: var(--primary); height: 100%; transition: 1s; }
    </style>
</head>
<body>

<header>
    <div class="logo-section">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <div>
            <div style="font-weight: 800; font-size: 16px;">FUEL PROOF</div>
            <div style="font-size: 10px; color: var(--warning);">ZAHRANI LOGISTICS</div>
        </div>
    </div>
    <div id="userAction"></div>
</header>

<main>
    <section id="authPage">
        <div class="card" style="max-width: 400px; margin: 50px auto;">
            <h2 style="text-align: center; margin-bottom: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="loginEmail" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <p id="authError" style="color: var(--danger); font-size: 12px; text-align: center;"></p>
        </div>
    </section>

    <section id="driverApp" class="hidden">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h3 id="drvName" style="margin: 0;">--</h3>
                    <small id="drvMeta" style="color: var(--text-muted);"></small>
                </div>
                <div class="stat-item" style="padding: 5px 15px;">
                    <span class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ø´Ø§Ø·</span>
                    <span id="monthlyOps" class="stat-val" style="font-size: 16px;">0</span>
                </div>
            </div>

            <div id="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div class="photo-grid">
                <div class="photo-box">
                    <p>Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</p>
                    <img id="prevBefore" src="">
                    <button onclick="takeSnap('before')" style="margin-top: 8px;">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø·</button>
                </div>
                <div class="photo-box">
                    <p>Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</p>
                    <img id="prevAfter" src="">
                    <button onclick="takeSnap('after')" style="margin-top: 8px;">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø·</button>
                </div>
            </div>

            <div id="opStatus" style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; font-size: 13px; text-align: center; margin-bottom: 15px;">
                Ø¬Ø§Ù‡Ø² Ù„Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯...
            </div>

            <div id="kmDifferenceDisplay" class="hidden" style="background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; border: 1px solid var(--warning);">
                <div style="font-size: 12px; color: var(--text-muted);">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</div>
                <div id="diffResult" style="font-size: 24px; font-weight: 800; color: var(--warning);">0 ÙƒÙ…</div>
            </div>

            <button id="submitBtn" class="btn-success" onclick="processSubmission()" style="padding: 18px; font-size: 18px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </section>

    <section id="adminPanel" class="hidden">
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                <span id="statTotal" class="stat-val">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</span>
                <span id="statToday" class="stat-val">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø´Ø¨ÙˆÙ‡Ø©</span>
                <span id="statWarn" class="stat-val" style="color: var(--danger);">0</span>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>
                <button onclick="exportData()" style="width: auto; padding: 5px 15px; font-size: 12px;">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                            <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                            <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h3>
            <div id="regionStats"></div>
        </div>
    </section>
</main>

<script>
// [PART 5] - Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentDriver = null;
let beforeImg = null, afterImg = null;
let kmB = 0, kmA = 0;
let stream = null;

// [PART 24] - Automatic Admin Creation (Enhanced)
function initSystem() {
    const adminMail = "honda@gmail.com";
    const adminPass = "0906212775"; // ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ
    
    auth.createUserWithEmailAndPassword(adminMail, adminPass).then(u => {
        db.ref('users/' + u.user.uid).set({
            role: 'admin', name: 'Ù‡ÙˆÙ†Ø¯Ø§ (Ø§Ù„Ù…Ø¯ÙŠØ±)', email: adminMail, status: 'active', createdAt: new Date().toISOString()
        });
    }).catch(e => console.log("System Ready."));
}
initSystem();

// [PART 7-9] - Auth Logic
function handleLogin() {
    const user = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;
    const email = user.includes('@') ? user : `${user}@gmail.com`;

    auth.signInWithEmailAndPassword(email, pass).catch(err => {
        document.getElementById('authError').innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    });
}

auth.onAuthStateChanged(user => {
    if(user) {
        db.ref('users/' + user.uid).once('value').then(snap => {
            const data = snap.val() || createDefaultUser(user);
            setupUI(data);
        });
    } else {
        showPage('authPage');
    }
});

function createDefaultUser(u) {
    const d = { role: 'driver', name: u.email.split('@')[0], email: u.email, project: 'Ø¹Ø§Ù…', region: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', status: 'active', createdAt: new Date().toISOString() };
    db.ref('users/' + u.uid).set(d);
    return d;
}

function setupUI(user) {
    currentDriver = user;
    document.getElementById('userAction').innerHTML = `<button onclick="auth.signOut()" style="background:none; color:var(--danger); width:auto;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`;
    
    if(user.role === 'admin') {
        showPage('adminPanel');
        loadAdminStats();
    } else {
        showPage('driverApp');
        document.getElementById('drvName').innerText = user.name;
        document.getElementById('drvMeta').innerText = `${user.project} - ${user.region}`;
        startCam();
    }
}

function showPage(id) {
    ['authPage', 'driverApp', 'adminPanel'].forEach(p => document.getElementById(p).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

// [PART 10] - Camera Logic
async function startCam() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        document.getElementById('video').srcObject = stream;
    } catch (e) { alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯."); }
}

async function takeSnap(type) {
    const v = document.getElementById('video');
    const c = document.getElementById('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.6);
    
    if(type === 'before') {
        beforeImg = data; document.getElementById('prevBefore').src = data;
        await runOCR(data, 'before');
    } else {
        afterImg = data; document.getElementById('prevAfter').src = data;
        await runOCR(data, 'after');
    }
}

// [PART 11] - AI OCR Logic (Gemini)
async function runOCR(img, type) {
    const status = document.getElementById('opStatus');
    status.innerText = "ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...";
    
    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyC0JhoFGiCh102Q9X0y0xaWgFG-NQINWUk`, {
            method: 'POST',
            body: JSON.stringify({ contents: [{ parts: [{ text: "Read the car odometer number. Return ONLY the numeric digits." }, { inline_data: { mime_type: "image/jpeg", data: img.split(',')[1] } }] }] })
        });
        const res = await resp.json();
        const text = res.candidates[0].content.parts[0].text.replace(/\D/g,'');
        const val = parseInt(text) || 0;
        
        if(type === 'before') kmB = val; else kmA = val;
        status.innerText = `âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: ${val}`;
        
        if(kmB > 0 && kmA > 0) {
            const diff = kmA - kmB;
            document.getElementById('kmDifferenceDisplay').classList.remove('hidden');
            document.getElementById('diffResult').innerText = `${diff} ÙƒÙ…`;
        }
    } catch (e) { status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."; }
}

// [PART 12-13] - Submission with HIDDEN GPS
function processSubmission() {
    if(!beforeImg || !afterImg) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯)");
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const diff = kmA - kmB;
        const report = {
            userId: auth.currentUser.uid,
            userName: currentDriver.name,
            project: currentDriver.project,
            region: currentDriver.region,
            kmBefore: kmB,
            kmAfter: kmA,
            diff: diff,
            beforeImg: beforeImg,
            afterImg: afterImg,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            isSuspicious: (diff <= 0 || diff > 150),
            timestamp: new Date().toISOString()
        };

        await db.ref('fuel_reports').push(report);
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
        location.reload();
    }, (err) => {
        alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
        btn.disabled = false;
        btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ";
    }, { enableHighAccuracy: true });
}

// [PART 14-16] - Admin Logic & Dashboard
function loadAdminStats() {
    db.ref('fuel_reports').on('value', snap => {
        const data = snap.val();
        if(!data) return;
        
        let html = '', total = 0, today = 0, warn = 0;
        const regions = {};
        const todayStr = new Date().toISOString().split('T')[0];

        Object.values(data).reverse().forEach(r => {
            total++;
            if(r.timestamp.includes(todayStr)) today++;
            if(r.isSuspicious) warn++;
            regions[r.region] = (regions[r.region] || 0) + 1;

            html += `
                <tr style="${r.isSuspicious ? 'background: rgba(220,38,38,0.1)' : ''}">
                    <td><strong>${r.userName}</strong><br><small>${r.project}</small></td>
                    <td><span style="color:var(--warning)">${r.diff} ÙƒÙ…</span></td>
                    <td>${r.region}</td>
                    <td><a href="https://maps.google.com/?q=${r.lat},${r.lng}" target="_blank" style="color:var(--primary)">ğŸ“ Ø¹Ø±Ø¶</a></td>
                    <td><span class="badge ${r.isSuspicious ? 'badge-warn' : 'badge-ok'}">${r.isSuspicious ? 'Ù…Ø´Ø¨ÙˆÙ‡' : 'Ø³Ù„ÙŠÙ…'}</span></td>
                </tr>`;
        });

        document.getElementById('statTotal').innerText = total;
        document.getElementById('statToday').innerText = today;
        document.getElementById('statWarn').innerText = warn;
        document.getElementById('logsTable').innerHTML = html;
        renderRegionCharts(regions, total);
    });
}

function renderRegionCharts(data, total) {
    let html = '';
    Object.entries(data).forEach(([name, count]) => {
        const per = Math.round((count/total)*100);
        html += `
            <div style="margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                    <span>${name}</span><span>${count} Ø¹Ù…Ù„ÙŠØ© (${per}%)</span>
                </div>
                <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${per}%"></div></div>
            </div>`;
    });
    document.getElementById('regionStats').innerHTML = html;
}

// [PART 21] - Export Data
async function exportData() {
    const snap = await db.ref('fuel_reports').once('value');
    const data = snap.val();
    let csv = "\ufeffØ§Ù„Ø³Ø§Ø¦Ù‚,Ø§Ù„Ù…Ø´Ø±ÙˆØ¹,Ø§Ù„Ù…Ù†Ø·Ù‚Ø©,Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø¨Ù„,Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¹Ø¯,Ø§Ù„Ù…Ø³Ø§ÙØ©,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®\n";
    
    Object.values(data).forEach(r => {
        csv += `${r.userName},${r.project},${r.region},${r.kmBefore},${r.kmAfter},${r.diff},${r.isSuspicious?'Ù…Ø´Ø¨ÙˆÙ‡':'Ø³Ù„ÙŠÙ…'},${r.timestamp}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Fuel_Report_${new Date().toLocaleDateString()}.csv`;
    link.click();
}
</script>

</body>
</html>
