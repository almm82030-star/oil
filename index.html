<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Proof | Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #ef4444; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--t); line-height: 1.6; }
        
        /* Header */
        header { background: var(--c); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--p); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-area img { height: 50px; border-radius: 10px; border: 1px solid var(--p); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .card { background: var(--c); padding: 25px; border-radius: 20px; border: 1px solid #334155; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 25px; }
        
        /* Inputs & Buttons */
        input, button, select { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 16px; outline: none; transition: 0.3s; }
        button { background: var(--p); border: none; font-weight: 900; cursor: pointer; color: white; }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-sec { background: transparent; border: 2px solid var(--p); color: var(--p); }
        .btn-success { background: var(--s); }

        /* Captcha Box */
        .captcha-wrapper { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px dashed var(--p); text-align: center; margin-bottom: 15px; }
        #captchaDisplay { font-size: 28px; font-weight: 900; color: var(--s); letter-spacing: 12px; user-select: none; font-style: italic; }
        
        /* Status UI */
        .hidden { display: none !important; }
        #video { width: 100%; max-width: 500px; border-radius: 20px; border: 4px solid var(--p); display: block; margin: 0 auto; box-shadow: 0 0 20px rgba(59,130,246,0.3); }
        
        /* Admin Table */
        .table-res { overflow-x: auto; border-radius: 15px; background: #1e293b; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #0f172a; padding: 15px; color: var(--p); font-size: 14px; border-bottom: 2px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; text-align: center; font-size: 13px; }
        .badge { padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 11px; }
        .badge-ok { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .badge-warn { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        @media (max-width: 600px) { .card { padding: 15px; } .logo-area img { height: 40px; } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="https://i.ibb.co/yFCW2v98/Untitled.webp" alt="Logo">
        <div>
            <div style="font-weight:900; color:var(--p); font-size: 18px; line-height: 1;">FUEL PROOF</div>
            <div style="font-size:10px; color:#94a3b8; font-weight:bold;">Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ Ù„ÙˆØ¬Ø³ØªÙŠÙƒ</div>
        </div>
    </div>
    <div id="userLabel" style="font-size:12px; font-weight:bold; color:var(--s);"></div>
</header>

<div class="container">
    <section id="authPage">
        <div class="card" style="max-width:450px; margin: 40px auto;">
            <h2 id="authTitle" style="text-align:center; color:var(--p); margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            
            <div id="loginGroup">
                <input type="text" id="email" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)">
                <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                
                <div class="captcha-wrapper">
                    <p style="font-size:11px; margin:0 0 5px 0;">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø£Ù…Ø§Ù†:</p>
                    <div id="captchaDisplay"></div>
                </div>
                <input type="text" id="captchaInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§">
                
                <button onclick="handleAuthAction()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                <button class="btn-sec" onclick="switchView(true)">Ø³Ø¬Ù„ ÙƒÙ€Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div id="registerGroup" class="hidden">
                <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø³Ø§Ø¦Ù‚">
                <input type="text" id="regProject" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡">
                <input type="text" id="regRegion" placeholder="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„">
                <input type="text" id="regUser" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-success" onclick="registerDriver()">ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn-sec" onclick="switchView(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            
            <div id="authErr" style="color:var(--d); text-align:center; margin-top:10px; font-weight:bold; font-size:14px;"></div>
        </div>
    </section>

    <section id="driverSec" class="hidden">
        <div class="card">
            <h3 style="margin:0 0 15px 0; color:var(--p);">ğŸ“¸ ØªÙˆØ«ÙŠÙ‚ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚ÙˆØ¯</h3>
            <video id="video" autoplay playsinline></video>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <div onclick="takeSnap('b')"><img id="v_b" src="" style="width:100%; border-radius:12px; height:120px; object-fit:cover; background:#000; border:1px solid var(--p);"><button style="font-size:11px; margin-top:5px;">ØªØµÙˆÙŠØ± (Ù‚Ø¨Ù„)</button></div>
                <div onclick="takeSnap('a')"><img id="v_a" src="" style="width:100%; border-radius:12px; height:120px; object-fit:cover; background:#000; border:1px solid var(--p);"><button style="font-size:11px; margin-top:5px;">ØªØµÙˆÙŠØ± (Ø¨Ø¹Ø¯)</button></div>
            </div>
            <div id="aiInfo" style="text-align:center; padding:10px; color:var(--p); font-weight:bold;"></div>
            <button class="btn-success" style="margin-top:10px;" onclick="uploadReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </section>

    <section id="adminSec" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                <button onclick="location.reload()" style="width:auto; padding:5px 15px; font-size:12px; background:var(--c); border:1px solid var(--p);">ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div class="table-res">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                            <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</th>
                            <th>Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                        </tr>
                    </thead>
                    <tbody id="adminLogs"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    appId: "1:285162278384:web:8264d5439564660b616135"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let activeCaptcha = "";

// Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚
function genCaptcha() {
    activeCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('captchaDisplay').innerText = activeCaptcha;
}
genCaptcha();

function switchView(isReg) {
    document.getElementById('loginGroup').classList.toggle('hidden', isReg);
    document.getElementById('registerGroup').classList.toggle('hidden', !isReg);
    document.getElementById('authTitle').innerText = isReg ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚' : 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
    genCaptcha();
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø¯ÙŠØ± Ø£Ùˆ Ø³Ø§Ø¦Ù‚)
function handleAuthAction() {
    const user = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value.trim();
    const cap = document.getElementById('captchaInput').value.trim();
    const err = document.getElementById('authErr');

    if(cap !== activeCaptcha) {
        err.innerText = "âŒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­!";
        genCaptcha();
        return;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙ‡Ù…ÙŠ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Firebase
    const email = user.includes('@') ? user : `${user}@fuelproof.com`;

    auth.signInWithEmailAndPassword(email, pass).then(u => {
        // Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§
        if(user === "honda@gmail.com" && pass === "212775@#") {
            db.ref('users/' + u.user.uid).update({ role: 'admin' });
        }
        location.reload();
    }).catch(() => {
        err.innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        genCaptcha();
    });
}

// ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯
function registerDriver() {
    const user = document.getElementById('regUser').value.trim();
    const pass = document.getElementById('regPass').value.trim();
    const name = document.getElementById('regName').value.trim();
    const proj = document.getElementById('regProject').value.trim();
    const reg = document.getElementById('regRegion').value.trim();

    if(!user || !pass || !name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    const email = `${user}@fuelproof.com`;

    auth.createUserWithEmailAndPassword(email, pass).then(u => {
        db.ref('users/' + u.user.uid).set({
            name, project: proj, region: reg, role: 'driver', status: 'active'
        }).then(() => location.reload());
    }).catch(e => alert(e.message));
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
auth.onAuthStateChanged(user => {
    if(user) {
        db.ref('users/' + user.uid).once('value').then(snap => {
            const d = snap.val();
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('userLabel').innerHTML = `ğŸ‘¤ ${d.name} | <a href="#" onclick="auth.signOut();location.reload()" style="color:var(--d);text-decoration:none;">Ø®Ø±ÙˆØ¬</a>`;
            if(d.role === 'admin') {
                document.getElementById('adminSec').classList.remove('hidden');
                fetchReports();
            } else {
                document.getElementById('driverSec').classList.remove('hidden');
                initCamera();
            }
        });
    }
});

// Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function initCamera() {
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('video').srcObject = s;
}

let bPic = null, aPic = null;
function takeSnap(t) {
    const v = document.getElementById('video');
    const c = document.createElement('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.5);
    if(t === 'b') { bPic = data; document.getElementById('v_b').src = data; }
    else { aPic = data; document.getElementById('v_a').src = data; }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (GPS ØµØ§Ù…Øª)
function uploadReport() {
    if(!bPic || !aPic) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±");
    navigator.geolocation.getCurrentPosition(p => {
        const report = {
            driver: auth.currentUser.email.split('@')[0],
            picB: bPic, picA: aPic,
            lat: p.coords.latitude, lng: p.coords.longitude,
            date: new Date().toLocaleString('ar-SA')
        };
        db.ref('final_reports').push(report).then(() => {
            alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­");
            location.reload();
        });
    }, () => alert("ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹"), {enableHighAccuracy: true});
}

// Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ù…Ø¯ÙŠØ±
function fetchReports() {
    db.ref('final_reports').on('value', s => {
        let h = '';
        s.forEach(c => {
            const v = c.val();
            h += `<tr>
                <td><b>${v.driver}</b></td>
                <td><span style="color:var(--p)">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span></td>
                <td><a href="https://maps.google.com/?q=${v.lat},${v.lng}" target="_blank" style="color:var(--s);text-decoration:none;">ğŸ“ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
                <td><img src="${v.picB}" width="40" style="border-radius:4px;"> <img src="${v.picA}" width="40" style="border-radius:4px;"></td>
                <td><span class="badge badge-ok">${v.date}</span></td>
            </tr>`;
        });
        document.getElementById('adminLogs').innerHTML = h || '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    });
}
</script>
</body>
</html>
