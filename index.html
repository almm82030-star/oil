<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fuel System Ultra â€“ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>

<!-- ================= PWA (inline) ================= -->
<link rel="manifest" href="data:application/json,{
 &quot;name&quot;:&quot;Fuel System Ultra â€“ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ&quot;,
 &quot;short_name&quot;:&quot;FuelUltra&quot;,
 &quot;start_url&quot;:&quot;.&quot;,
 &quot;display&quot;:&quot;standalone&quot;,
 &quot;background_color&quot;:&quot;#0f172a&quot;,
 &quot;theme_color&quot;:&quot;#0f172a&quot;
}">
<meta name="theme-color" content="#0f172a">

<!-- ================= Firebase ================= -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
/* ================= UI ================= */
:root{--bg:#0f172a;--card:#1e293b;--p:#3b82f6;--s:#22c55e;--d:#ef4444}
body{margin:0;font-family:tahoma;background:var(--bg);color:#fff}
.card{background:var(--card);margin:10px;padding:15px;border-radius:12px}
input,button,select{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none}
button{background:var(--p);color:#fff;font-weight:bold;cursor:pointer}
.hidden{display:none}
.top{display:flex;gap:6px}
.top button{flex:1}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #334155;padding:6px;text-align:center}
img{width:70px;border-radius:6px}
video{width:120px}
</style>
</head>

<body>

<!-- ================= TOP BAR ================= -->
<div class="card top">
<button onclick="toggleLang()">ğŸŒ</button>
<button id="installBtn" class="hidden">ğŸ“² ØªØ«Ø¨ÙŠØª</button>
</div>

<!-- ================= AUTH ================= -->
<div id="auth" class="card">
<h3 id="t_login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
<input id="l_user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="l_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>

<hr>
<button style="background:var(--s)" onclick="showReg()">+ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</button>

<div id="regBox" class="hidden">
<input id="r_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">
<input id="r_user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="r_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<input id="r_project" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
<input id="r_area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
<button onclick="register()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
</div>
</div>

<!-- ================= DRIVER ================= -->
<div id="driver" class="card hidden">
<h3 id="driverName"></h3>
<video id="cam" autoplay playsinline></video>
<button onclick="capture()">ğŸ“¸ ØµÙˆØ±Ø©</button>
<button onclick="record()">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ 5 Ø«ÙˆØ§Ù†ÙŠ</button>
<button onclick="send()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="admin" class="card hidden">
<h3 id="t_admin">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
<th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
<th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
/* ================= CONFIG ================= */
// Firebase
firebase.initializeApp({
 apiKey: "PUT_YOUR_KEY",
 authDomain: "PUT_YOUR.firebaseapp.com",
 databaseURL: "https://PUT_YOUR.firebaseio.com",
 projectId: "PUT_YOUR"
});

// Cloudinary
const CLOUD_NAME="dfgp8dwj3";
const UPLOAD_PRESET="fuel_unsigned";

// Encryption
const ENC_KEY="fuel-ultra-key";

// ================= GLOBAL =================
const authF=firebase.auth(), db=firebase.database();
let currentUserData=null, lang="ar";
let stream, imgEnc=null, videoBlob=null;

/* ================= LANGUAGE ================= */
const dict={
 ar:{login:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",admin:"Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±"},
 en:{login:"Login",admin:"Admin Panel"}
};
function toggleLang(){
 lang=lang==="ar"?"en":"ar";
 document.dir=lang==="ar"?"rtl":"ltr";
 t_login.textContent=dict[lang].login;
 t_admin.textContent=dict[lang].admin;
}

/* ================= PWA ================= */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
 e.preventDefault(); deferredPrompt=e;
 installBtn.classList.remove("hidden");
});
installBtn.onclick=()=>{deferredPrompt.prompt();};

/* ================= DEVICE ID ================= */
async function deviceId(){
 const d=navigator.userAgent+screen.width+screen.height;
 const h=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(d));
 return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ================= ENCRYPT ================= */
function enc(t){return btoa([...t].map((c,i)=>String.fromCharCode(c.charCodeAt(0)^ENC_KEY.charCodeAt(i%ENC_KEY.length))).join(""))}
function dec(t){return atob(t).split("").map((c,i)=>String.fromCharCode(c.charCodeAt(0)^ENC_KEY.charCodeAt(i%ENC_KEY.length))).join("")}

/* ================= AUTH ================= */
authF.onAuthStateChanged(async u=>{
 if(!u) return;
 auth.classList.add("hidden");
 currentUserData=(await db.ref("users/"+u.uid).get()).val();

 if(currentUserData.role==="admin"){
  admin.classList.remove("hidden");
  loadReports();
 }else{
  driver.classList.remove("hidden");
  driverName.textContent=currentUserData.name;
  startCam();
 }
});

/* ================= LOGIN ================= */
function login(){
 authF.signInWithEmailAndPassword(l_user.value+"@z.com",l_pass.value)
 .then(()=>log("login"))
 .catch(()=>alert("Ø®Ø·Ø£ Ø¯Ø®ÙˆÙ„"));
}

/* ================= REGISTER DRIVER ================= */
function showReg(){regBox.classList.toggle("hidden")}
function register(){
 authF.createUserWithEmailAndPassword(r_user.value+"@z.com",r_pass.value)
 .then(r=>db.ref("users/"+r.user.uid).set({
  name:r_name.value,
  username:r_user.value,
  project:r_project.value,
  area:r_area.value,
  role:"driver"
 }))
 .then(()=>alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„"))
 .catch(e=>alert(e.message));
}

/* ================= CAMERA ================= */
async function startCam(){
 stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
 cam.srcObject=stream;
}
function capture(){
 const c=document.createElement("canvas");
 c.width=400;c.height=300;
 c.getContext("2d").drawImage(cam,0,0,400,300);
 imgEnc=enc(c.toDataURL("image/jpeg",0.6));
 alert("ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±");
}
function record(){
 const r=new MediaRecorder(stream);let ch=[];
 r.ondataavailable=e=>ch.push(e.data);
 r.onstop=()=>videoBlob=new Blob(ch,{type:"video/webm"});
 r.start();setTimeout(()=>r.stop(),5000);
}

/* ================= CLOUDINARY ================= */
async function upload(file){
 const f=new FormData();
 f.append("file",file);
 f.append("upload_preset",UPLOAD_PRESET);
 const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:"POST",body:f});
 return (await r.json()).secure_url;
}

/* ================= SEND REPORT ================= */
async function send(){
 const dev=await deviceId();
 const imgUrl=await upload(dec(imgEnc));
 const vidUrl=await upload(videoBlob);

 const sigBuf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(dev+imgUrl));
 const sig=[...new Uint8Array(sigBuf)].map(b=>b.toString(16)).join("");

 db.ref("reports").push({
  ...currentUserData,
  device:dev,
  img:enc(imgUrl),
  video:vidUrl,
  signature:sig,
  ts:firebase.database.ServerValue.TIMESTAMP
 });
 log("send_report");
 alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
}

/* ================= ADMIN ================= */
function loadReports(){
 db.ref("reports").on("value",s=>{
  rows.innerHTML="";
  s.forEach(c=>{
   const r=c.val();
   rows.innerHTML+=`
<tr>
<td>${r.name}</td>
<td>${r.project}</td>
<td>${r.area}</td>
<td>${new Date(r.ts).toLocaleString('ar-SA')}</td>
<td>${r.device.slice(0,8)}</td>
<td><img src="${dec(r.img)}"></td>
<td>
 <video controls src="${r.video}"></video><br>
 <a href="${r.video}" download>ØªØ­Ù…ÙŠÙ„</a>
</td>
<td>${r.signature.slice(0,8)}</td>
</tr>`;
  });
 });
}

/* ================= AUDIT LOG ================= */
function log(type){
 db.ref("audit").push({
  uid:authF.currentUser?.uid||"guest",
  type,
  ua:navigator.userAgent,
  ts:firebase.database.ServerValue.TIMESTAMP
 });
}
</script>

</body>
</html>

